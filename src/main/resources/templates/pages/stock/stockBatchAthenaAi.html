<!-- stockBatchAthenaAi.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .chart-canvas-wrap{width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;min-height:300px;}
    #chartCanvas,#macdCanvas{width:100%;height:360px;}
    @media(max-width:640px){#chartCanvas,#macdCanvas{height:260px;}}

    .accordion-section { border-bottom: 1px solid #e5e7eb; }
    
    /* í—¤ë” ë†’ì´ ë° í°íŠ¸ ì¶•ì†Œ */
.accordion-header { 
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 0.6rem 1rem; /* ìƒí•˜ íŒ¨ë”©ì„ 1remì—ì„œ 0.6remìœ¼ë¡œ ì¶•ì†Œ */
  font-size: 1rem;      /* í°íŠ¸ í¬ê¸°ë¥¼ 1.25remì—ì„œ 1remìœ¼ë¡œ ì¶•ì†Œ */
  font-weight: 700;
  cursor: pointer;
  transition: background-color 0.2s; 
}
    
    .accordion-header:hover { background-color:#eef2ff; }

    .accordion-content {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: scaleY(0.95);
      transform-origin: top;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .accordion-content.open {
      max-height: 1000px;
      opacity: 1;
      transform: scaleY(1);
    }

    .option-card-wrapper { cursor:pointer; transition:all 0.25s ease; }
    .option-card {
      border:2px solid #d1d5db;
      border-radius:12px;
      padding:1rem;
      text-align:center;
      background-color:#fff;
      font-weight:600;
      transition:all 0.25s ease;
    }
    .option-card-wrapper:hover .option-card {
      border-color:#818cf8;
      background-color:#eef2ff;
    }
    input[type="radio"]:checked + .option-card {
      border-color:#4f46e5;
      background-color:#eef2ff;
      box-shadow:0 0 8px rgba(79,70,229,0.3);
      transform:scale(1.03);
    }
    input[type="radio"]:not(:checked) + .option-card { opacity:0.7; }

    .rotate-icon { transition:transform 0.4s ease; }
    .rotate-icon.open { transform:rotate(180deg); }

    .status-running { color:#3b82f6; font-weight:bold; }
    .status-locked { color:#f59e0b; font-weight:bold; }
    .status-completed { color:#22c55e; font-weight:bold; }
    .status-failed { color:#ef4444; font-weight:bold; }
    .status-cancelled { color:#9ca3af; font-weight:bold; }
    .status-idle { color:#6b7280; }

    @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }
    .status-running.blinking { animation:blink 1s infinite; }

    .tooltip-container { position:relative; display:inline-block; }
    .info-icon { margin-left:5px; font-size:0.8em; font-weight:bold; color:#4f46e5; cursor:pointer; }
    .tooltip-box {
      visibility:hidden; opacity:0; transition:opacity 0.3s;
      width:200px; background-color:#333; color:#fff;
      text-align:left; border-radius:6px; padding:10px;
      position:absolute; z-index:10; bottom:125%; left:50%;
      margin-left:-100px; font-size:0.85em; line-height:1.4;
    }
    .tooltip-box.visible { visibility:visible; opacity:1; }
    .tooltip-box::after {
      content:""; position:absolute; top:100%; left:50%; margin-left:-5px;
      border-width:5px; border-style:solid; border-color:#333 transparent transparent transparent;
    }

    .modal-open-fix { overflow:hidden!important; position:fixed; width:100%; height:100vh; top:0; left:0; }

    @keyframes fadeInUp { from{transform:translateY(30px);opacity:0;} to{transform:translateY(0);opacity:1;} }
    .loader { border-top-color:#4f46e5; animation:spin 1s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg);} }

    #chartModal { align-items:center; justify-content:center; }
    #chartModal .modal-card { margin:auto; transform:translateY(0); }
    
    
    
button:disabled {
  opacity: 0.4 !important;
  cursor: not-allowed !important;
  pointer-events: none !important;
}
  </style>

  <!-- ë°˜ë“œì‹œ Chart.jsë³´ë‹¤ ë¨¼ì € -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>


<body>
<div layout:fragment="content">
<div class="content-container p-4 md:p-6 lg:p-8">

<!-- ğŸ“Œ í—¤ë” -->
	<div class="page-header">
	  <div class="page-title">
	    <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©</h2>
	  </div>
	  <div class="breadcrumb">
	    <i class="fas fa-folder-open"></i>
	    <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'">ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ</span>
	  </div>
	</div>   

<!-- ğŸŒ ì „ì—­ ìƒíƒœ -->
<div class="global-status-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-6">
  <div class="flex justify-between items-center mb-2">
    <span class="font-bold text-lg">ğŸŒ AthenaAI ì „ì—­ ë°°ì¹˜ ì§„í–‰ ìƒíƒœ</span>
    <span id="globalStatusText" class="text-gray-500">ëŒ€ê¸°ì¤‘</span>
  </div>
  <div class="flex justify-between text-sm text-gray-600 mb-2">
    <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
    <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
  </div>
  <div class="w-full h-3 bg-gray-200 rounded-lg overflow-hidden">
    <div id="globalProgressBar" class="h-full bg-blue-600 transition-all duration-300" style="width:0%"></div>
  </div>
</div>

<!-- âš™ï¸ ì•„ì½”ë””ì–¸ ì¹´ë“œ -->
<div class="card bg-white border border-gray-200 rounded-xl p-5 mb-10 shadow-sm">
  <form id="analysisForm" class="space-y-4">

  <div class="accordion-section">
  <div class="accordion-header" onclick="toggleAccordion('analysisTypeContent', 'icon1')">
    <span class="flex items-center gap-2">1ï¸âƒ£ ë¶„ì„ ìœ í˜• ì„ íƒ</span>
    <i id="icon1" class="fas fa-chevron-down rotate-icon text-sm"></i>
  </div>
  <div id="analysisTypeContent" class="accordion-content open p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
    
    <label class="option-card-wrapper">
      <input type="radio" name="analysisType" id="maRadio" value="long_term_down_trend" class="hidden" checked onclick="toggleMaPeriods()">
      <div class="option-card border py-1.5 px-2 rounded-md text-xs sm:text-sm">ğŸ“‰ ì¥ê¸°í•˜ë½</div>
    </label>

    <label class="option-card-wrapper">
      <input type="radio" name="analysisType" value="double_bottom" class="hidden" onclick="toggleMaPeriods()">
      <div class="option-card border py-1.5 px-2 rounded-md text-xs sm:text-sm">ğŸ“ˆ ì´ì¤‘ë°”ë‹¥</div>
    </label>

    <label class="option-card-wrapper">
      <input type="radio" name="analysisType" value="triple_bottom" class="hidden" onclick="toggleMaPeriods()">
      <div class="option-card border py-1.5 px-2 rounded-md text-xs sm:text-sm">ğŸ“Š ì‚¼ì¤‘ë°”ë‹¥</div>
    </label>

    <label class="option-card-wrapper">
      <input type="radio" name="analysisType" value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()">
      <div class="option-card border py-1.5 px-2 rounded-md text-xs sm:text-sm">â˜• ì»µì•¤í•¸ë“¤</div>
    </label>

    <label class="option-card-wrapper">
      <input type="radio" name="analysisType" value="half_cup" class="hidden" onclick="toggleMaPeriods()">
      <div class="option-card border py-1.5 px-2 rounded-md text-xs sm:text-sm">ğŸŒ“ í•˜í”„ì•¤í•¸ë“¤</div>
    </label>

  </div>
</div>

    <!-- MA ì˜µì…˜ -->
	<div id="maPeriodsContainer" class="bg-indigo-50/50 border border-indigo-100 rounded-lg px-3 py-1.5 mt-2 mb-4">
  <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
    <div class="flex items-center gap-1.5">
      <span class="text-xs font-bold text-indigo-600 uppercase tracking-wider">MA Periods</span>
    </div>
    
    <div class="hidden sm:block w-px h-3 bg-indigo-200"></div>

    <div class="flex items-center gap-4 text-sm">
      <label class="flex items-center cursor-not-allowed opacity-70">
        <input type="checkbox" id="ma20" value="20" checked disabled class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 mr-1.5">
        <span class="text-xs font-bold text-gray-700">20ì¼ (í•„ìˆ˜)</span>
      </label>
  
      <label class="flex items-center cursor-pointer group">
        <input type="checkbox" id="ma50" name="maPeriods" value="50" checked class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1.5">
        <span class="text-xs text-gray-600 group-hover:text-indigo-600 transition-colors font-medium">50ì¼</span>
      </label>
  
      <label class="flex items-center cursor-pointer group">
        <input type="checkbox" id="ma200" name="maPeriods" value="200" checked class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1.5">
        <span class="text-xs text-gray-600 group-hover:text-indigo-600 transition-colors font-medium">200ì¼</span>
      </label>
    </div>
  </div>
</div>


    <!-- 2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜ + ê²°ê³¼ ê°œìˆ˜ -->
<div class="accordion-section">
  <div class="accordion-header" onclick="toggleAccordion('executionOptionsContent', 'icon2')">
    <span class="flex items-center gap-2">2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜ ë° í•„í„°</span>
    <i id="icon2" class="fas fa-chevron-down rotate-icon text-sm"></i>
  </div>
  
  <div id="executionOptionsContent" class="accordion-content open p-2">
    <div class="grid grid-cols-3 gap-1.5">
      
      <div class="flex items-center justify-between px-2 h-8 bg-gray-50 border border-gray-200 rounded-md">
        <div class="flex items-center gap-1 min-w-0">
          <i class="fas fa-microchip text-gray-400 text-[9px]"></i>
          <span class="text-[10px] font-bold text-gray-600 truncate">ì‘ì—…ì</span>
        </div>
        <input id="workerCount" type="number" value="8" min="1" max="16" 
               style="font-size: 10px !important;"
               class="w-11 text-center bg-white border border-gray-200 rounded outline-none font-black text-indigo-600 h-6 focus:border-indigo-400">
      </div>

      <div class="flex items-center justify-between px-2 h-8 bg-gray-50 border border-gray-200 rounded-md">
        <div class="flex items-center gap-1 min-w-0">
          <i class="fas fa-list-ol text-gray-400 text-[9px]"></i>
          <span class="text-[10px] font-bold text-gray-600 truncate">ìƒìœ„ N</span>
        </div>
        <input id="topNCount" type="number" value="20" min="1" max="50" 
               style="font-size: 10px !important;"
               class="w-11 text-center bg-white border border-gray-200 rounded outline-none font-black text-indigo-600 h-6 focus:border-indigo-400">
      </div>

      <div class="flex items-center justify-between px-2 h-8 bg-purple-50 border border-purple-100 rounded-md">
        <div class="flex items-center gap-1 min-w-0">
          <i class="fas fa-bolt text-purple-500 text-[9px]"></i>
          <span class="text-[10px] font-bold text-purple-700 truncate">ê°•ì œë¶„ì„</span>
        </div>
        <label class="relative inline-flex items-center cursor-pointer shrink-0">
          <input type="checkbox" id="forceAnalysis" class="sr-only peer">
          <div class="w-7 h-3.5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-3.5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-purple-600"></div>
        </label>
      </div>

    </div>
  </div>
</div>

	
  </form>

  <!-- ì‹¤í–‰/ì·¨ì†Œ ë²„íŠ¼ -->
	<div class="flex gap-1.5 mt-3">
  <button id="runAnalysisBtn" onclick="runAnalysis()" 
          class="flex-1 flex items-center justify-center gap-1.5 bg-indigo-600 hover:bg-indigo-700 text-white h-8 rounded-md transition-all shadow-sm active:scale-[0.98]">
    <i class="fas fa-play text-[9px]"></i>
    <span class="text-[11px] font-bold">ë¶„ì„ ì‹¤í–‰</span>
  </button>
  
  <button id="btnCancel" onclick="cancelAnalysis()" 
          class="flex-1 flex items-center justify-center gap-1.5 bg-rose-500 hover:bg-rose-600 disabled:bg-gray-100 disabled:text-gray-400 text-white h-8 rounded-md transition-all shadow-sm active:scale-[0.98]" 
          disabled>
    <i class="fas fa-stop text-[9px]"></i>
    <span class="text-[11px] font-bold">ë¶„ì„ ì·¨ì†Œ</span>
  </button>
</div>
  
</div>

<!-- ê²°ê³¼/ë¡œê·¸ ì¹´ë“œ -->
<div class="card bg-white border rounded-md p-3 mb-10 shadow-sm">
  <h3 class="text-sm font-bold mb-3 flex items-center gap-2 text-gray-700">
    <span class="text-indigo-500">ğŸ“Š</span> ë¶„ì„ ê²°ê³¼
  </h3>

  <div class="overflow-x-auto border border-gray-100 rounded-md">
    <table class="min-w-full table-fixed md:table-auto" id="resultTable">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">ìˆœìœ„</th>       
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">ì¢…ëª©ì½”ë“œ</th>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">ì¢…ëª©ëª…</th>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">ì‹ í˜¸</th>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">MA ë°°ì—´</th>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase border-r border-gray-100 last:border-r-0">í¬ë¡œìŠ¤</th>
          <th class="px-2 py-1.5 text-[11px] font-black text-gray-500 uppercase">ì°¨íŠ¸</th>
        </tr>
      </thead>
      <tbody id="resultTableBody" class="divide-y divide-gray-100 bg-white text-center">
        </tbody>
    </table>
  </div>
  
  <div id="noResultBox" class="hidden py-10 text-center border-t border-gray-50">
    <div class="flex flex-col items-center gap-2">
      <i class="fas fa-search text-gray-300 text-xl"></i>
      <span class="text-[11px] font-bold text-gray-400">ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
    </div>
  </div>
</div>

<div class="card bg-white border rounded-md p-3 mb-10 shadow-sm">
  <h3 class="text-sm font-bold mb-3 flex items-center justify-between text-gray-700">
    <div class="flex items-center gap-2">
      <span class="text-indigo-500">ğŸ“œ</span> ì‹¤ì‹œê°„ ë¡œê·¸
    </div>
    <button id="copyLogBtn" class="text-[10px] bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-0.5 rounded transition-all">ë¡œê·¸ ë³µì‚¬</button>
  </h3>
  <div id="logBox" class="h-48 bg-gray-900 text-emerald-400 p-2 overflow-y-auto font-mono rounded-md border border-gray-800 shadow-inner" style="font-size: 10px !important;">
    <p class="text-gray-500 opacity-50">[SYSTEM] ë¡œê·¸ ëŒ€ê¸° ì¤‘...</p>
  </div>
</div>

<!-- ğŸ“ˆ ì°¨íŠ¸ ëª¨ë‹¬ (ì™„ì „ ë°˜ì‘í˜• ì¤‘ì•™ ì •ë ¬ + ìŠ¤í¬ë¡¤ ë½ + ì• ë‹ˆë©”ì´ì…˜ ì ìš©) -->
<div id="chartModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999] p-4">
  <div class="modal-card bg-white rounded-2xl w-full max-w-[95vw] sm:max-w-2xl md:max-w-3xl lg:max-w-5xl max-h-[90vh] overflow-y-auto p-4 relative shadow-2xl animate-[fadeInUp_0.25s_ease-out]">
    <h2 id="modalTitle" class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-left pl-2 pr-24"></h2>

    <!-- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="chartLoading" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center z-20">
      <div class="loader border-4 border-t-4 border-gray-200 border-t-indigo-500 rounded-full w-10 h-10 animate-spin"></div>
    </div>

    <!-- âœ… ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
    <div class="chart-canvas-wrap mb-4">
      <canvas id="chartCanvas"></canvas>
    </div>
    <div class="chart-canvas-wrap mb-2">
      <canvas id="macdCanvas"></canvas>
    </div>

    <!-- âœ… ìƒë‹¨ ì œì–´ ë²„íŠ¼ -->
    <div class="absolute top-3 right-3 flex items-center gap-2">
      <button id="btnResetZoom" class="hidden bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
        ğŸ”„ ì¤Œ ì´ˆê¸°í™”
      </button>
      <button id="btnSaveChart" class="hidden bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 transition">
        ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥
      </button>
      <button onclick="closeChartModal()" class="text-gray-500 hover:text-black text-lg font-bold">âœ–</button>
    </div>
  </div>
</div>


</div>
</div>


<th:block layout:fragment="pageScript">

<script>

/* ==========================================================
 * ğŸ“œ AthenaAI (chart + analyze) í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ (ì™„ì„±íŒ)
 * - Chart.js Financial + Zoom í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
 * - JSON ì°¨íŠ¸ ë Œë”ë§ ì•ˆì •í™” (animation:false)
 * - payload.results ì œê±° â†’ payload ì§ì ‘ íŒŒì‹± (Aì•ˆ)
 * - SSE ìƒíƒœ ë™ê¸°í™” + ì‹¤í–‰/ì·¨ì†Œ
 * - ë¡œê·¸ + ê²°ê³¼ í…Œì´ë¸” + ì°¨íŠ¸ ëª¨ë‹¬ ì™„ì „ í†µí•©
 * ========================================================== */

/* ----------------------------------------------------------
 *  ì•„ì½”ë””ì–¸
 * ---------------------------------------------------------- */
/* window.toggleAccordion = function(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  const isOpen = content.classList.contains('open');

  if (window.innerWidth < 768) {
    document.querySelectorAll('.accordion-content').forEach(c => { if (c !== content) c.classList.remove('open'); });
    document.querySelectorAll('.rotate-icon').forEach(i => { if (i !== icon) i.classList.remove('open'); });
  }

  content.classList.toggle('open', !isOpen);
  icon.classList.toggle('open', !isOpen);
}; */

/* ----------------------------------------------------------
 * ì•„ì½”ë””ì–¸ (ê°œë³„ ë…ë¦½ í† ê¸€ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
 * ---------------------------------------------------------- */
window.toggleAccordion = function(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  
  // í˜„ì¬ ìƒíƒœ ë°˜ì „ (ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê³ , ë‹«í˜€ìˆìœ¼ë©´ ì—´ê¸°)
  const isOpen = content.classList.contains('open');

  // [ìˆ˜ì • í¬ì¸íŠ¸] ë‹¤ë¥¸ ì•„ì½”ë””ì–¸ì„ ë‹«ëŠ” forEach ë¡œì§ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
  content.classList.toggle('open', !isOpen);
  icon.classList.toggle('open', !isOpen);
};


/* ----------------------------------------------------------
 *  ì¦‰ì‹œ ì‹¤í–‰ ìŠ¤ì½”í”„
 * ---------------------------------------------------------- */
(function () {

	let esGlobal = null;

	function connectGlobalSSE() {
	  if (esGlobal) { try { esGlobal.close(); } catch(e){} }

	  esGlobal = new EventSource("/api/global/sse");

	  esGlobal.addEventListener("status", (ev) => {
		    const d = JSON.parse(ev.data || "{}");

		    updateGlobalState(
		        d.globalStatus,
		        d.globalRunner,
		        d.globalProgress
		    );

		    updateButtonState(
		        d.globalStatus,
		        d.globalRunner
		    );
		});


	  esGlobal.onerror = () => {
	    try{ esGlobal.close(); }catch(e){}
	    setTimeout(connectGlobalSSE, 2000);
	  };
	}

	
	
  /* ----------------------------------------------------------
   * DOM í•¸ë“¤
   * ---------------------------------------------------------- */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");
  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");
  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $modalTitle = document.getElementById("modalTitle");
  const $btnResetZoom = document.getElementById('btnResetZoom');
  const $btnSaveChart = document.getElementById('btnSaveChart');
  const $chartLoading = document.getElementById('chartLoading');

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  const $priceCanvas = document.getElementById('chartCanvas');
  const $macdCanvas  = document.getElementById('macdCanvas');

  let priceChart = null;
  let macdChart  = null;

  let currentTaskId = null;
  let es = null;
  let currentUser = "ë¯¸ì—°ê²°";
  let globalStatus = "IDLE";

  /* ----------------------------------------------------------
   * Chart.js Financial / Zoom í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
   * ---------------------------------------------------------- */
  (function ensureFinancialRegistered(){
    try {
      const hasCandle =
        (Chart?.registry?.controllers?.get?.('candlestick')) ||
        (Chart?.controllers && (Chart.controllers.candlestick || Chart.FinancialController));

      if (!hasCandle) {
        const candlestick = (Chart.FinancialController || Chart.controllers?.candlestick);
        const ohlc        = (Chart.OhlcController      || Chart.controllers?.ohlc);
        if (candlestick) Chart.register(candlestick);
        if (ohlc)        Chart.register(ohlc);
      }

      const zoomCandidate = window.ChartZoom || window.chartjsPluginZoom || window.Zoom || window['chartjs-plugin-zoom'];
      if (zoomCandidate && typeof zoomCandidate.id === 'string') {
        Chart.register(zoomCandidate);
      }
    } catch (e) {}
  })();


  /* ----------------------------------------------------------
   * íŒ¨í„´/MA ì„ íƒ íŒŒì‹±
   * ---------------------------------------------------------- */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }

  function getMaPeriods() {
    const maPeriodsElements = document.querySelectorAll('input[name="maPeriods"]:checked');
    return Array.from(maPeriodsElements)
      .map(el => el.value)
      .filter((value, index, self) => self.indexOf(value) === index)
      .sort((a, b) => parseInt(a) - parseInt(b))
      .join(',');
  }

  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    if (!box) return;
    const inputs = box.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(input => {
      if (input.id === 'ma20') return;
      input.disabled = !isMA;
    });
    box.style.display = isMA ? "block" : "none";
  };


  /* ----------------------------------------------------------
   * ë¡œê·¸
   * ---------------------------------------------------------- */
  function appendLog(line) {
    if (!line) return;
    const p = document.createElement("p");

    if (line.includes("[ERROR]") || line.includes("ì‹¤íŒ¨")) p.className = 'text-red-500';
    else if (line.includes("WARNING")) p.className = 'text-yellow-500';
    else if (line.includes("COMPLETED")) p.className = 'text-green-500 font-extrabold';
    else p.className = 'text-gray-300';

    p.textContent = line;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");

    if (t.trim() === 'ë¡œê·¸ ëŒ€ê¸°ì¤‘...') {
      appendLog("[LOG] ë³µì‚¬í•  ë¡œê·¸ ì—†ìŒ");
      return;
    }

    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };


  /* ----------------------------------------------------------
   * ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
   * ---------------------------------------------------------- */
   function renderResults(list) {
	   $resultTableBody.innerHTML = "";
	   if (!list || list.length === 0) {
	     $noResultBox.classList.remove("hidden");
	     return;
	   }
	   $noResultBox.classList.add("hidden");

	   list.forEach((item, index) => {
	     const rowId = `result-row-${item.ticker}`;
	     const tr = document.createElement("tr");
	     // ë¶„ìœ„ê¸°ì— ë§ì¶˜ ë¶€ë“œëŸ¬ìš´ í˜¸ë²„ íš¨ê³¼ ë° ë°°ê²½ìƒ‰
	     tr.className = 'hover:bg-indigo-50/50 transition-colors border-b border-gray-50';

	     const conditions = item.technical_conditions || {};
	     
	     // ë°°ì§€(Badge) ë””ìì¸ë„ ìŠ¬ë¦¼í•˜ê²Œ ë³€ê²½
	     const cross =
	       conditions.goldencross_50_200_detected
	         ? `<span class="bg-rose-500 text-white text-[9px] px-1.5 py-0.5 rounded font-black">â­ ê³¨ë“ </span>`
	         : conditions.deadcross_50_200_detected
	             ? `<span class="bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded font-black">ğŸ’€ ë°ë“œ</span>`
	             : `<span class="text-gray-300 text-[10px]">-</span>`;

	     // ëª¨ë“  tdì— font-size 10px !important ì ìš© ë° íŒ¨ë”© ì¶•ì†Œ
	     const tdStyle = `style="font-size: 10px !important; padding: 4px 8px;"`;

	     tr.innerHTML = `
	       <td class="font-bold text-gray-400" ${tdStyle}>${(index + 1).toString().padStart(2, '0')}</td>
	       <td class="font-medium text-gray-500" ${tdStyle}>${item.ticker || "-"}</td>
	       <td class="font-black text-gray-800" ${tdStyle}>${item.name || "-"}</td>
	       <td class="font-bold text-indigo-600" ${tdStyle}>${conditions.market_regime || "-"}</td>
	       <td class="font-medium text-gray-600" ${tdStyle}>${conditions.down_trend_status || "-"}</td>
	       <td ${tdStyle}>${cross}</td>
	       <td class="text-center" style="padding: 4px 8px;">
	         <button class="px-2 py-0.5 bg-gray-100 hover:bg-indigo-600 hover:text-white rounded text-[9px] font-black transition-all"
	                 onclick="showChart('${item.ticker}', '${item.name}')">VIEW</button>
	       </td>
	     `;
	     $resultTableBody.appendChild(tr);
	   });

	   appendLog(`[LOG] ê²°ê³¼ ${list.length}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
	 }


  /* ----------------------------------------------------------
   * ì°¨íŠ¸ ê³µí†µ ìœ í‹¸
   * ---------------------------------------------------------- */
  function destroyCharts() {
    try { priceChart?.destroy(); } catch(e){}
    try { macdChart?.destroy(); } catch(e){}
    priceChart = null;
    macdChart = null;
  }

  /* ----------------------------------------------------------
   * ì¢Œí‘œ ìœ í‹¸
   * ---------------------------------------------------------- */
  function toXY(ds) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => {
      const ts = new Date(d.x).getTime();
      if (isNaN(ts) || d.y == null) return null;
      return { x: ts, y: d.y };
    }).filter(Boolean);
  }

  /* ----------------------------------------------------------
   * Price Chart  (ë¹ˆ ë°ì´í„°ë©´ ì°¨íŠ¸ ìƒëµ â†’ í•˜ì–€ ë°°ê²½/íŒ¨ë‹ ë²„ê·¸ ì™„ì „í•´ê²°)
   * ---------------------------------------------------------- */
  function buildPriceChart(ctx, payload) {

    const raw = payload.ohlcv_data;
    if (!raw || !Array.isArray(raw) || raw.length === 0) {
      // ë°ì´í„° ì—†ìœ¼ë©´ ì°¨íŠ¸ ìƒì„±í•˜ì§€ ì•ŠìŒ
      return;
    }

    const ohlcData = raw.map(d => {
      const ts = new Date(d.x).getTime();
      if (isNaN(ts)) return null;
      return { x: ts, o: d.o, h: d.h, l: d.l, c: d.c };
    }).filter(Boolean);

    const ma20  = payload.ma_data?.MA20  ? toXY(payload.ma_data.MA20)  : [];
    const ma50  = payload.ma_data?.MA50  ? toXY(payload.ma_data.MA50)  : [];
    const ma200 = payload.ma_data?.MA200 ? toXY(payload.ma_data.MA200) : [];

    priceChart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [
          { label:'OHLCV', data:ohlcData, parsing:false, borderWidth:1 },
          { type:'line', label:'MA20',  data:ma20,  parsing:false, pointRadius:0, borderWidth:1, borderColor:'#22c55e' },
          { type:'line', label:'MA50',  data:ma50,  parsing:false, pointRadius:0, borderWidth:1, borderColor:'#7c3aed' },
          { type:'line', label:'MA200', data:ma200, parsing:false, pointRadius:0, borderWidth:1, borderColor:'#3b82f6' }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        interaction:{ mode:'nearest', intersect:false },
        parsing:false,
        scales:{
          x:{
            type:'time',
            time:{ tooltipFormat:'yyyy-MM-dd' },
            adapters:{ date:{ zone:'Asia/Seoul' }},
            grid:{ display:false }
          },
          y:{
            beginAtZero:false,
            ticks:{ callback:v => v.toLocaleString() }
          }
        },
        plugins:{
          zoom:{
            limits:{ x:{ min:'original', max:'original' } }, /* ì¢Œìš° ë ì•ˆë‚ ì•„ê°€ê²Œ ê³ ì • */
            zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' },
            pan:{ enabled:true, mode:'x' }
          },
          legend:{ labels:{ usePointStyle:true } }
        }
      }
    });
  }


  /* ----------------------------------------------------------
   * MACD Chart (ë¹ˆ ë°ì´í„° ë°©ì§€)
   * ---------------------------------------------------------- */
   function buildMacdChart(ctx, payload) {

	   const macdRaw  = payload.macd_data?.MACD;
	   const sigRaw   = payload.macd_data?.Signal;
	   const histRaw  = payload.macd_data?.Histogram;

	   if (!macdRaw || !sigRaw || !histRaw) {
	     return;
	   }

	   const macd   = toXY(macdRaw);
	   const signal = toXY(sigRaw);
	   const hist   = toXY(histRaw);

	   if (macd.length === 0 && signal.length === 0 && hist.length === 0) {
	     return;
	   }

	   macdChart = new Chart(ctx, {
	     data: {
	       datasets: [
	         {
	           type: 'line',
	           label: 'MACD',
	           data: macd,
	           parsing: false,
	           pointRadius: 0,
	           borderWidth: 1,
	           borderColor: '#111827'
	         },
	         {
	           type: 'line',
	           label: 'Signal',
	           data: signal,
	           parsing: false,
	           pointRadius: 0,
	           borderWidth: 1,
	           borderColor: '#f43f5e'
	         },
	         {
	           type: 'bar',
	           label: 'Histogram',
	           data: hist,
	           parsing: false,
	           borderWidth: 0,
	           backgroundColor: ctx => {
	             const v = ctx.parsed.y;
	             return v > 0
	               ? 'rgba(34,197,94,0.7)'
	               : 'rgba(239,68,68,0.7)';
	           }
	         }
	       ]
	     },

	     options:{
	       responsive:true,
	       maintainAspectRatio:false,
	       animation:false,
	       parsing:false,
	       interaction:{ mode:'nearest', intersect:false },

	       scales:{
	         x:{
	           type:'time',
	           time:{ tooltipFormat:'yyyy-MM-dd' },
	           adapters:{ date:{ zone:'Asia/Seoul' }},
	           grid:{ display:false }
	         },
	         y:{ beginAtZero:false }
	       },

	       plugins:{
	         zoom:{
	           limits:{ x:{ min:'original', max:'original' }},
	           zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' },
	           pan:{ enabled:true, mode:'x' }
	         },
	         legend:{ labels:{ usePointStyle:true } }
	       }
	     }
	   });
	 }




  /* ----------------------------------------------------------
   * fetch â†’ ì°¨íŠ¸ ë Œë”ë§
   * ---------------------------------------------------------- */
  async function tryRenderChartsByJson(ticker, name) {

    const url = `/api/stock/batch/athena/chart?symbol=${encodeURIComponent(ticker)}&ts=${Date.now()}`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
    if (!res.ok) throw new Error("HTTP " + res.status);

    const ct = res.headers.get('Content-Type') || '';
    if (!ct.includes('application/json')) throw new Error("JSON ì•„ë‹˜");

    const payload = await res.json();

    destroyCharts();

    buildPriceChart($priceCanvas.getContext('2d'), payload);
    buildMacdChart($macdCanvas.getContext('2d'), payload);

    $btnResetZoom.classList.remove("hidden");
    $btnSaveChart.classList.remove("hidden");

    $btnResetZoom.onclick = () => {
      priceChart?.resetZoom?.();
      macdChart?.resetZoom?.();
    };

    $btnSaveChart.onclick = () => {
      try {
        const c1 = $priceCanvas;
        const c2 = $macdCanvas;

        const merged = document.createElement('canvas');
        merged.width  = Math.max(c1.width, c2.width);
        merged.height = c1.height + c2.height + 20;

        const ctx2 = merged.getContext('2d');
        ctx2.fillStyle = '#ffffff';
        ctx2.fillRect(0,0,merged.width, merged.height);

        ctx2.drawImage(c1,0,0);
        ctx2.drawImage(c2,0,c1.height+10);

        const link = document.createElement('a');
        link.download = `${ticker}_${name}_chart.png`;
        link.href = merged.toDataURL('image/png');
        link.click();
      } catch(e) {
        appendLog("[ERROR] ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    };
  }


  /* ----------------------------------------------------------
   * ëª¨ë‹¬ showChart
   * ---------------------------------------------------------- */
  window.showChart = async (ticker, name) => {
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartModal.classList.remove("hidden");
    document.body.classList.add('modal-open-fix');

    $chartLoading.classList.remove("hidden");
    await new Promise(r => setTimeout(r, 120));

    try {
      await tryRenderChartsByJson(ticker, name);
    } catch (err) {
      destroyCharts();
      $btnResetZoom.classList.add('hidden');
      $btnSaveChart.classList.add('hidden');
      appendLog("[ERROR] ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨: " + err.message);
    } finally {
      $chartLoading.classList.add("hidden");
    }
  };

  window.closeChartModal = () => {
    $chartModal.classList.add("hidden");
    destroyCharts();
    document.body.classList.remove('modal-open-fix');
  };


  /* ----------------------------------------------------------
   * SSE ì—°ê²°
   * ---------------------------------------------------------- */
  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    let pct = 0;

    if (S === "COMPLETED") pct = 100;
    else if (S === "RUNNING") pct = Math.floor(progress || 0);
    else pct = 0;

    $globalStatusText.textContent = S;
    $globalRunner.textContent = runner || "ë¯¸ì—°ê²°";
    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING" && runner === currentUser) $globalStatusText.classList.add("status-running","blinking");
    else if (S === "RUNNING") $globalStatusText.classList.add("status-locked");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  function updateButtonState(status, runner) {
    const S = (status || "IDLE").toUpperCase();
    const isRunning = ["START","IN_PROGRESS","RUNNING"].includes(S);
    const isOwner = (runner === currentUser);

    if (!isRunning) {
      $runBtn.disabled = false;
    } else {
      $runBtn.disabled = true;
    }

    $cancelBtn.disabled = !(isRunning && isOwner);
  }

  function connectSSE() {
    if (es) { try { es.close(); } catch(e){} }

    es = new EventSource("/api/stock/batch/athena/sse");
    es.onopen = () => appendLog("[LOG] SSE ì—°ê²° ì„±ê³µ.");

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");

      if (d.globalStatus) {
        updateGlobalState(d.globalStatus,d.globalRunner,d.globalProgress);
        updateButtonState(d.globalStatus,d.globalRunner);
      }
      if (Array.isArray(d.logs)) d.logs.forEach(line=>appendLog(line));
      if (Array.isArray(d.results)) renderResults(d.results);
      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      appendLog("[ERROR] SSE ì˜¤ë¥˜, ì¬ì‹œë„");
      try { es.close(); } catch(e){}
      es = null;
      setTimeout(connectSSE, 2000);
    };
  }


  /* ----------------------------------------------------------
   * ì‹¤í–‰/ì·¨ì†Œ
   * ---------------------------------------------------------- */
   window.runAnalysis = async () => {
	   if ($runBtn.disabled) return;

	   $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ìš”ì²­ ì¤‘...</p>`;
	   $resultTableBody.innerHTML = "";
	   $noResultBox.classList.add("hidden");

	   const pattern = getSelectedPattern();
	   const workers = document.getElementById("workerCount").value;
	   const topN = document.getElementById("topNCount").value;
	   const maPeriods = getMaPeriods();
	   
	   // ğŸ”¥ ì¶”ê°€: ê°•ì œ ë¶„ì„ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ ê°’ ê°€ì ¸ì˜¤ê¸°
	   const force = document.getElementById("forceAnalysis").checked;

	   const url =
	     `/api/stock/batch/athena/start`
	     + `?pattern=${encodeURIComponent(pattern)}`
	     + `&workers=${encodeURIComponent(workers)}`
	     + `&maPeriods=${encodeURIComponent(maPeriods)}`
	     + `&topN=${encodeURIComponent(topN)}`
	     + `&force=${force}`; // ğŸ”¥ ì„œë²„ APIë¡œ force ì¸ì ì „ë‹¬

	   try {
	     const res = await fetch(url,{ method:'POST' });
	     if (!res.ok) {
	       appendLog("[ERROR] ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨");
	     } else {
	       const data = await res.json();
	       currentTaskId = data.taskId;
	       appendLog(`[LOG] ë¶„ì„ ì‹œì‘ (Force:${force}): TaskID ${currentTaskId}`);
	     }
	   } catch(e) {
	     appendLog("[FATAL] ë¶„ì„ ìš”ì²­ ì˜¤ë¥˜: " + e.message);
	   }
	 };

  window.cancelAnalysis = async () => {
    if (!currentTaskId) {
      appendLog("[WARNING] ì·¨ì†Œí•  ì‘ì—… ì—†ìŒ");
      return;
    }
    try {
      const res = await fetch(`/api/stock/batch/athena/cancel/${encodeURIComponent(currentTaskId)}`, { method:'POST' });
      if (!res.ok) appendLog("[ERROR] ì·¨ì†Œ ì‹¤íŒ¨");
      else appendLog("[LOG] ì·¨ì†Œ ì™„ë£Œ");
    } catch(e) {
      appendLog("[ERROR] ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜: " + e.message);
    }
  };


  /* ----------------------------------------------------------
   * í˜„ì¬ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸°
   * ---------------------------------------------------------- */
  async function initCurrentUser() {
    try {
      const res = await fetch("/auth/me",{ credentials:'include' });
      if (!res.ok) return;
      const data = await res.json();
      currentUser = data.username || data.fullName || "-";
    } catch(e){}
  }


  /* ----------------------------------------------------------
   * ì´ˆê¸° ì‹¤í–‰
   * ---------------------------------------------------------- */
   document.addEventListener("DOMContentLoaded", () => {
	   toggleMaPeriods();
	   initCurrentUser().then(() => {
	     connectGlobalSSE();  // â† ì´ ì¤„ ì¶”ê°€
	     connectSSE();        // ê¸°ì¡´ AthenaAI SSE
	   });
	 })

})();

</script>


</th:block>


</body>
</html>
