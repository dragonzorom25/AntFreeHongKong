<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>ğŸ“Š Stock Batch GProd</title>

<style>
:root {
  --main-bg: #f3f4f6;
  --card-bg: #ffffff;
  --text-color-primary: #111827;
  --text-color-secondary: #6b7280;
  --border-color-default: #d1d5db;
  --input-bg: #ffffff;
  --progress-bar-bg: #e5e7eb;
  
  /* ë¡œê·¸ ë°•ìŠ¤ ì „ìš© ìƒ‰ìƒ */
  --log-box-bg: #1e293b;
  --log-text-default: #f1f5f9;
  --log-text-info: #cbd5e1;
  --log-text-progress: #7dd3fc;
  --log-text-warning: #fde047;
  --log-text-error: #fca5a5;
  --log-text-complete: #86efac;
}

body.dark-mode {
  --main-bg: #1f2937;
  --card-bg: #374151;
  --text-color-primary: #f9fafb;
  --text-color-secondary: #9ca3af;
  --border-color-default: #4b5563;
}

/* UI ë ˆì´ì•„ì›ƒ */
h2 { font-size: 1.1rem; font-weight: 700; color: var(--text-color-primary); margin: 0; }
.content-container { padding: 0.8rem; max-width: 1200px; margin: 0 auto; }

/* ì½¤íŒ©íŠ¸ ì œì–´ë¶€ */
.card-box { 
  background: var(--card-bg); 
  border-radius: 8px; 
  padding: 8px 12px; 
  border: 1px solid var(--border-color-default); 
  margin-top: 8px; 
}
.controls { 
  display: flex; 
  gap: 12px; 
  align-items: center; 
  font-size: 0.8rem; 
}
.control-item { display: flex; align-items: center; gap: 6px; color: var(--text-color-secondary); }

input[type=number], select { 
  padding: 2px 6px; 
  border: 1px solid var(--border-color-default); 
  border-radius: 4px; 
  font-size: 0.8rem; 
  background: var(--input-bg); 
  color: var(--text-color-primary);
  height: 28px;
}
input[type=number] { width: 45px; }
select { width: 65px; }

.btn { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  padding: 0 12px; 
  height: 30px; 
  border-radius: 6px; 
  border: none; 
  cursor: pointer; 
  font-size: 0.8rem; 
  font-weight: 600; 
  color: #fff; 
  transition: all 0.2s;
}
.btn-start { background: #2563eb; border: 1px solid #1d4ed8; }
.btn-start:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); }

.btn-cancel { background: #9ca3af; border: 1px solid #6b7280; cursor: not-allowed; opacity: 0.6; }
.btn-cancel.active { 
  background: #dc2626 !important; 
  border-color: #b91c1c !important; 
  cursor: pointer !important; 
  opacity: 1 !important;
  animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
  70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.admin-hint { 
  font-size: 10px; 
  color: #9ca3af; 
  margin-top: 4px; 
  display: flex; 
  justify-content: space-between; 
  padding-left: 2px;
}

.global-status-card { background: var(--card-bg); border: 1px solid var(--border-color-default); border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; }
.global-status-header { font-weight: 700; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
.global-status-body { font-size: 0.75rem; color: var(--text-color-secondary); display: flex; justify-content: space-between; margin-top: 4px; }
.global-status-progress { width: 100%; height: 5px; background: var(--progress-bar-bg); border-radius: 3px; overflow: hidden; margin-top: 4px; }
.global-status-progress div { height: 100%; width: 0%; background: #2563eb; transition: width 0.25s; }

.dashboard-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
.card { background: var(--card-bg); border: 1px solid var(--border-color-default); border-radius: 8px; padding: 10px; }
.card-header { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; font-weight: 600; margin-bottom: 3px; color: var(--text-color-secondary); }
.card-header i { color: #2563eb; }
.card strong { font-size: 1.1rem; font-weight: 800; display: block; margin-bottom: 4px; }
.progress-bar { width: 100%; background: var(--progress-bar-bg); height: 6px; border-radius: 3px; overflow: hidden; }
.progress-bar div { height: 100%; width: 0%; transition: width 0.25s; }
.bar-total div { background: #2563eb; }
.bar-krx div { background: #10b981; }
.bar-data div { background: #f59e0b; }

/* ë¡œê·¸ ì„¹ì…˜ - ìš¸ë ê±°ë¦¼ ë°©ì§€ ë° ì—¬ë°± ìµœì í™” */
.log-wrapper { background: var(--card-bg); border-radius: 8px; padding: 10px; border: 1px solid var(--border-color-default); margin-top: 10px; }
.log-wrapper h3 { font-size: 0.8rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; margin-top: 0;}
.log-box { 
  background: var(--log-box-bg); 
  color: var(--log-text-default); 
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
  font-size: 12px; /* ê°€ë…ì„±ì„ ìœ„í•´ ì‚´ì§ í‚¤ì›€ */
  padding: 10px 12px;
  border-radius: 6px; 
  height: 240px; 
  overflow-y: auto; 
  line-height: 1.5; /* ìš¸ë ê±°ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ê³ ì • ìˆ˜ì¹˜ ì‚¬ìš© */
  
  /* Flex ì œê±° (ìš¸ë ê±°ë¦¼ì˜ ì£¼ ì›ì¸) */
  display: block; 
  
  /* ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ìµœì í™” */
  overflow-anchor: auto; 
}

/* ë¡œê·¸ í•­ëª© ê³µí†µ ìŠ¤íƒ€ì¼ */
.log-box p { 
  margin: 0; 
  padding: 0;
  white-space: pre-wrap; 
  word-break: break-all;
  min-height: 1.5em; /* í…ìŠ¤íŠ¸ê°€ ì—†ì–´ë„ ë†’ì´ ìœ ì§€ */
}

.log-default { color: var(--log-text-default); }
.log-info { color: var(--log-text-info); }
.log-progress { color: var(--log-text-progress); }
.log-warning { color: var(--log-text-warning); }
.log-error { color: var(--log-text-error); font-weight: bold; }
.log-complete { color: var(--log-text-complete); }

.error-log-card { border: 1px solid #fee2e2; border-radius: 8px; margin-top: 8px; overflow: hidden; }
.error-log-header { background: #fef2f2; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; font-weight: 700; color: #b91c1c; }
.error-log-header button { font-size: 0.7rem; padding: 1px 6px; border: 1px solid #fca5a5; background: #fff; border-radius: 4px; cursor: pointer; }
.error-log-list { display: none; max-height: 100px; overflow-y: auto; font-size: 11px; padding: 5px 10px; background: #fff; }

.status-running { color: #2563eb; }
.status-completed { color: #22c55e; }
.status-failed { color: #ef4444; }
.status-cancelled { color: #f59e0b; }
.blinking { animation: blink 1.2s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

@media(max-width: 768px) {
  .dashboard-cards { grid-template-columns: 1fr; }
  .controls { flex-wrap: wrap; }
}
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div class="page-title"><h2>ğŸ“Š ì „ì—­ ì¢…ëª©ìˆ˜ì§‘</h2></div>
      <div style="font-size:0.7rem; color:var(--text-color-secondary);">
        <i class="fas fa-database"></i> <span>ë°ì´í„° / Global ì—…ë°ì´íŠ¸</span>
      </div>
    </div>

    <div class="global-status-card">
      <div class="global-status-header">
        <span>ğŸŒ Global ìƒíƒœ: <span id="globalStatusText" class="status-idle">-</span></span>
        <span id="globalProgressLabel" style="color:#2563eb;">0%</span>
      </div>
      <div class="global-status-body">
        <div>Runner: <span id="globalRunner">-</span></div>
      </div>
      <div class="global-status-progress"><div id="globalProgressBar"></div></div>
    </div>

    <div class="card-box">
      <div class="controls">
        <div class="control-item">
          <span>ì›Œì»¤</span>
          <input type="number" id="workers" value="4" min="1" max="6">
        </div>
        <div class="control-item">
          <span>ê¸°ê°„</span>
          <select id="historyYears">
            <option value="3" selected>3ë…„</option><option value="4">4ë…„</option>
            <option value="5">5ë…„</option><option value="10">10ë…„</option>
          </select>
        </div>
        <div class="control-item">
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="checkbox" id="force"> <span style="font-size:0.75rem;">ê°•ì œ</span>
          </label>
        </div>
        <div style="margin-left:auto; display:flex; gap:6px;">
          <button id="btnStart" class="btn btn-start"><i class="fas fa-play" style="font-size:0.7rem; margin-right:4px;"></i>ì‹œì‘</button>
          <button id="btnCancel" class="btn btn-cancel" disabled><i class="fas fa-stop" style="font-size:0.7rem; margin-right:4px;"></i>ì·¨ì†Œ</button>
        </div>
      </div>
      <div class="admin-hint">
        <span id="hintStatus">â€» ê´€ë¦¬ì ì „ìš©</span>
        <span id="hintTimer"></span>
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header"><i class="fas fa-layer-group"></i>ì „ì²´ <span id="badgeTotal" class="right">-</span></div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="fas fa-database"></i>KRX <span id="badgeKrx" class="right"></span></div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="fas fa-chart-line"></i>ë°ì´í„° <span id="badgeData" class="right"></span></div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="error-log-card">
      <div class="error-log-header">
        <span>âŒ ìˆ˜ì§‘ ì‹¤íŒ¨</span>
        <button id="errorToggleBtn">í¼ì¹˜ê¸°</button>
      </div>
      <div id="errorListBox" class="error-log-list"></div>
    </div>

    <div class="log-wrapper">
      <h3>
        <span><i class="fas fa-terminal"></i> ë¡œê·¸</span>
        <span id="copyLogBtn" style="cursor:pointer; font-size:0.7rem; color:#3b82f6;"><i class="fas fa-copy"></i> ë³µì‚¬</span>
      </h3>
      <div id="logBox" class="log-box">
        <p class="log-info">[SYSTEM] ë¡œê·¸ ëŒ€ê¸° ì¤‘...</p>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function() {
  // ==========================================================
  // ğŸŒ ì „ì—­(Global) SSE ìˆ˜ì‹  â€” ëª¨ë“  ë©”ë‰´ ê³µí†µ
  // ==========================================================
  let globalEs = new EventSource("/api/global/sse");

  globalEs.addEventListener("status", (event) => {
    try {
      const d = JSON.parse(event.data || "{}");
      const s = (d.globalStatus || "IDLE").toUpperCase();
      const $globalStatusText = document.getElementById("globalStatusText");
      const $globalRunner = document.getElementById("globalRunner");
      const $globalProgressLabel = document.getElementById("globalProgressLabel");
      const $globalProgressBar = document.getElementById("globalProgressBar");

      if ($globalStatusText) {
        $globalStatusText.textContent = s;
        $globalStatusText.className = "";
        if (s === "RUNNING") $globalStatusText.classList.add("status-running","blinking");
        else if (s === "COMPLETED") $globalStatusText.classList.add("status-completed");
        else if (s === "FAILED") $globalStatusText.classList.add("status-failed");
        else if (s === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
        else $globalStatusText.classList.add("status-idle");
      }

      if ($globalRunner) $globalRunner.textContent = d.globalRunner || "-";
      const v = Math.min(100, Math.max(0, Math.floor(d.globalProgress || 0)));
      if ($globalProgressLabel) $globalProgressLabel.textContent = v + "%";
      if ($globalProgressBar) $globalProgressBar.style.width = v + "%";
    } catch(e) { console.warn("Global SSE error:", e); }
  });

  globalEs.onerror = function() {
    setTimeout(() => { globalEs.close(); globalEs = new EventSource("/api/global/sse"); }, 2000);
  };

  const $btnStart = document.getElementById("btnStart"),
        $btnCancel = document.getElementById("btnCancel"),
        $barTotal = document.getElementById("barTotal"),
        $pctTotal = document.getElementById("pctTotal"),
        $badgeTotal = document.getElementById("badgeTotal"),
        $barKrx = document.getElementById("barKrx"),
        $pctKrx = document.getElementById("pctKrx"),
        $badgeKrx = document.getElementById("badgeKrx"),
        $barData = document.getElementById("barData"),
        $pctData = document.getElementById("pctData"),
        $badgeData = document.getElementById("badgeData"),
        $log = document.getElementById("logBox"),
        $workers = document.getElementById("workers"),
        $force = document.getElementById("force"),
        $historyYears = document.getElementById("historyYears"),
        $hintTimer = document.getElementById("hintTimer"),
        $errorBox = document.getElementById("errorListBox"),
        $errorBtn = document.getElementById("errorToggleBtn");

  let currentTaskId = null, es = null, startTime = null, timerInterval = null;
  let currentUser = "-", firstEventReceived = false;
  const errorLogs = [];

  function updateButtonState(running, isOwner = true) {
    if (running) {
      $btnStart.disabled = true;
      if (isOwner) {
        $btnCancel.disabled = false;
        $btnCancel.classList.add("active");
      } else {
        $btnCancel.disabled = true;
        $btnCancel.classList.remove("active");
      }
    } else {
      $btnStart.disabled = false;
      $btnCancel.disabled = true;
      $btnCancel.classList.remove("active");
    }
  }

  function setBar(bar, pctEl, pctVal, status) {
    let v = Math.max(0, Math.min(100, Math.floor(pctVal || 0)));
    if (v >= 100 && ["FAILED","CANCELLED","TIMEOUT"].includes((status||"").toUpperCase()))
      v = Math.max(0, v - 1);
    bar.style.width = v + "%";
    pctEl.textContent = v + "%";
  }

  function resetUI() {
    setBar($barTotal, $pctTotal, 0);
    setBar($barKrx, $pctKrx, 0);
    setBar($barData, $pctData, 0);
    $badgeTotal.textContent = "-";
    $badgeKrx.textContent = "";
    $badgeData.textContent = "";
    $log.innerHTML = '<p class="log-info">[SYSTEM] ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p>';
    $errorBox.innerHTML = "";
    errorLogs.length = 0;
    currentTaskId = null;
    updateButtonState(false);
  }

  $errorBtn.onclick = () => {
    const open = $errorBox.style.display === "block";
    $errorBox.style.display = open ? "none" : "block";
    $errorBtn.textContent = open ? "í¼ì¹˜ê¸°" : "ì ‘ê¸°";
  };

  function addErrorLog(line) {
    if (!/ERROR|ì‹¤íŒ¨|TIMEOUT|ì˜¤ë¥˜/.test(line)) return;
    if (errorLogs.includes(line)) return;
    errorLogs.push(line);
    const div = document.createElement("div");
    div.className = "error-log-item";
    div.style.cssText = "padding:3px 0; border-bottom:1px dashed #fecaca; cursor:pointer; color:#b91c1c;";
    div.textContent = line;
    div.onclick = () => {
      const target = Array.from($log.querySelectorAll("p")).find(p => p.textContent.includes(line));
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.style.background = "#450a0a";
        setTimeout(() => target.style.background = "", 2000);
      }
    };
    $errorBox.appendChild(div);
  }

  function appendLog(msg) {
    if (!msg) return;
    const p = document.createElement("p");
    
    // í´ë˜ìŠ¤ íŒë³„ ë¡œì§
    if (/ERROR|ì‹¤íŒ¨|ì˜¤ë¥˜/.test(msg)) p.className = "log-error";
    else if (/ì™„ë£Œ|ì„±ê³µ/.test(msg)) p.className = "log-complete";
    else if (/ì¤€ë¹„|ì‹œì‘|ë°°ì¹˜/.test(msg)) p.className = "log-progress";
    else if (/ì£¼ì˜|ê²½ê³ /.test(msg)) p.className = "log-warning";
    else if (/^\[SYSTEM\]/.test(msg)) p.className = "log-info";
    else p.className = "log-default"; // ëª…ì‹œì ìœ¼ë¡œ log-default ì¶”ê°€
    
    p.textContent = msg;
    $log.appendChild(p);
    
    // ìë™ ìŠ¤í¬ë¡¤
    $log.scrollTop = $log.scrollHeight;
    
    addErrorLog(msg);
  }

  function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const sec = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(sec / 60), s = sec % 60;
      $hintTimer.textContent = `â± ${m>0 ? m+"ë¶„ " : ""}${s}ì´ˆ`;
    }, 1000);
  }
  function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }

  function connect() {
    if (es) try { es.close(); } catch {}
    resetUI();
    es = new EventSource("/api/stock/batch/gprod/sse", { withCredentials: true });

    es.addEventListener("status", e => {
      const d = JSON.parse(e.data || "{}");
      if (d.taskId) currentTaskId = d.taskId;
      if (d.status === "INIT") resetUI();

      if (typeof d.krxTotal === "number" && typeof d.krxSaved === "number") {
        const krxPct = d.krxTotal === 0 ? 0 : (d.krxSaved * 100 / d.krxTotal);
        setBar($barKrx, $pctKrx, krxPct, d.status);
        $badgeKrx.textContent = d.krxTotal === 0 ? "" : `${d.krxSaved}/${d.krxTotal}`;
      }

      if (typeof d.dataTotal === "number" && typeof d.dataSaved === "number") {
        const dataPct = d.dataTotal === 0 ? 0 : (d.dataSaved * 100 / d.dataTotal);
        setBar($barData, $pctData, dataPct, d.status);
        $badgeData.textContent = d.dataTotal === 0 ? "" : `${d.dataSaved}/${d.dataTotal}`;
      }

      if (typeof d.progress === "number") setBar($barTotal, $pctTotal, d.progress, d.status);
      if (Array.isArray(d.logs)) d.logs.forEach(appendLog);

      const isOwner = (typeof d.owner === "boolean") ? d.owner : (d.runner && d.runner === currentUser);
      
      if (["START", "IN_PROGRESS", "RUNNING"].includes(d.status)) {
        if (!startTime) startTimer();
        updateButtonState(true, isOwner);
      } else if (["COMPLETED", "FAILED", "CANCELLED", "TIMEOUT"].includes(d.status)) {
        stopTimer();
        updateButtonState(false);
        if (d.status === "COMPLETED") $badgeTotal.textContent = "âœ… ì™„ë£Œ";
      }
    });

    es.onerror = () => { setTimeout(connect, 2000); };
  }

  document.getElementById("copyLogBtn").onclick = () => {
    const text = Array.from($log.querySelectorAll("p")).map(p => p.textContent).join("\n");
    navigator.clipboard.writeText(text).then(() => appendLog("[SYSTEM] ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ."));
  };

  $btnStart.onclick = async () => {
    updateButtonState(true, true);
    const url = `/api/stock/batch/gprod/start?workers=${$workers.value}&historyYears=${$historyYears.value}&force=${$force.checked}`;
    const res = await fetch(url, { method: "POST", credentials: "include" });
    if (res.ok) {
      const d = await res.json();
      currentTaskId = d.taskId;
      startTimer();
    } else {
      updateButtonState(false);
      appendLog("[ERROR] ìš”ì²­ ì‹¤íŒ¨.");
    }
  };

  $btnCancel.onclick = async () => {
    if (!currentTaskId || $btnCancel.disabled) return;
    $btnCancel.disabled = true;
    await fetch(`/api/stock/batch/gprod/cancel/${currentTaskId}`, { method: "POST", credentials: "include" });
  };

  (async function() {
    try {
      const res = await fetch("/auth/me");
      const data = await res.json();
      currentUser = data.username || data.fullName || "-";
    } catch(e) {}
    connect();
  })();
})();
</script>
</th:block>

</body>
</html>