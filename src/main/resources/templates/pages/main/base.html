<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <style>
    body { margin: 0; font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }
    .content-container { width: 100%; padding: 15px; box-sizing: border-box; }
    /* âœ… ì „ê´‘íŒì€ ê·¸ë¦¬ë“œ í˜•íƒœë¡œ ê½‰ ì°¨ê²Œ */
    .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 10px; }
    .news-item {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px;
      display: flex; align-items: center; cursor: pointer; height: 48px; box-sizing: border-box;
      transition: transform 0.1s;
    }
    .news-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    .news-item.golden { border-left: 4px solid #ef4444; background-color: #fff1f2; }
    .news-item.golden .news-title { color: #b91c1c; font-weight: 800; }
    .news-badge { background: #3b82f6; color: white; font-size: 0.7rem; font-weight: 800; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin-right: 10px; }
    .ofer-tag { background: #f1f5f9; color: #64748b; font-size: 0.65rem; padding: 1px 5px; border-radius: 3px; margin-right: 8px; border: 1px solid #e2e8f0; }
    .news-title { font-size: 0.85rem; font-weight: 500; color: #334155; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .news-time { font-size: 0.7rem; color: #94a3b8; margin-left: 8px; font-variant-numeric: tabular-nums; }

    /* âœ… ì‹¤ì‹œê°„ RUNNING ê¹œë¹¡ì´ ìŠ¤íƒ€ì¼ */
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    .running-status { display: flex; align-items: center; gap: 6px; font-weight: 800; color: #3b82f6; font-size: 0.75rem; animation: blink 1.5s infinite; letter-spacing: 0.5px; }
    .status-dot { width: 8px; height: 8px; background-color: #3b82f6; border-radius: 50%; box-shadow: 0 0 5px #3b82f6; }
    .running-status.error { color: #ef4444; animation: none; }
    .running-status.error .status-dot { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="content-container">
    <div style="display:flex; align-items:center; margin-bottom:15px;">
      <b style="font-size:1.2rem; letter-spacing: -0.5px;">ğŸœ ì‹¤ì‹œê°„ KIS ë‰´ìŠ¤ ì „ê´‘íŒ</b>
      
      <div style="margin-left:auto; display:flex; flex-direction:column; align-items:flex-end;">
        <div id="status-container" class="running-status">
          <div id="status-dot" class="status-dot"></div>
          <span id="status-text">SYSTEM RUNNING</span>
        </div>
        <span id="header-time" style="font-size:0.65rem; color:#64748b; margin-top:2px; font-family: monospace;">CONNECTING...</span>
      </div>
    </div>

    <div id="news-list" class="news-grid"></div>
  </div>

<th:block layout:fragment="pageScript">
<script>
  let lastFingerprint = "";

  // ğŸš© ì„œë²„ê°€ ì¤€ link(êµ¬ê¸€URL)ë¥¼ ê·¸ëŒ€ë¡œ ì—¬ëŠ” í•¨ìˆ˜
  function openNews(url) {
      if (url && url.startsWith('http')) {
          window.open(url, '_blank');
      }
  }

  function refreshData() {
      fetch('/api/newsKisTypeAList?mode=dashboard')
      .then(res => res.json())
      .then(data => {
          document.getElementById('status-container').classList.remove('error');
          document.getElementById('status-text').innerText = "SYSTEM RUNNING";

          if (data.content && data.content.length > 0) {
              const newsList = data.content; 
              const currentFingerprint = newsList.map(n => n.id + n.title).join('|');
              
              if(lastFingerprint !== currentFingerprint) {
                  const html = newsList.map((news, idx) => {
                      const isGolden = news.featureOption === 'GOLDEN' || (news.title && news.title.includes('íŠ¹ì§•ì£¼'));
                      const goldenClass = isGolden ? 'golden' : '';
                      
                      let displayTime = "";
                      if(news.regDate && news.regDate.length >= 16) {
                          displayTime = news.regDate.substring(11, 16);
                      }

                      // ğŸš© ë§í¬ì— ë”°ì˜´í‘œê°€ ì„ì—¬ì„œ JSê°€ ê¹¨ì§€ëŠ” ê²ƒë§Œ ë°©ì§€
                      const safeLink = news.link ? news.link.replace(/'/g, "\\'") : "";

                      return `
                          <div class="news-item ${goldenClass}" 
                               onclick="openNews('${safeLink}')">
                              <span class="news-badge">${idx + 1}</span>
                              <span class="ofer-tag">${news.stockName || 'KIS'}</span>
                              <div class="news-title" title="${news.title}">${news.title}</div>
                              <div class="news-time">${displayTime}</div>
                          </div>
                      `;
                  }).join('');
                  
                  document.getElementById('news-list').innerHTML = html;
                  lastFingerprint = currentFingerprint;
              }
          }
          
          const now = new Date();
          document.getElementById('header-time').innerText = "LAST UPDATE: " + now.toLocaleTimeString('ko-KR', { hour12: false });

      }).catch(err => {
          console.error("ë°ì´í„° ìˆ˜ì§‘ ì—ëŸ¬:", err);
          document.getElementById('status-container').classList.add('error');
          document.getElementById('status-text').innerText = "SYSTEM ERROR";
      });
  }
  
  refreshData(); 
  setInterval(refreshData, 5000); 
</script>
</th:block>
</div>
</body>
</html>