<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>ë‰´ìŠ¤í†µí•©RSS</title>
</head>

<body>
<div layout:fragment="content">

  <div class="content-container">
    <div class="page-header">
      <div class="page-title">
        <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ğŸ“„ ë‰´ìŠ¤</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'">ë‰´ìŠ¤ / ë‰´ìŠ¤í†µí•©RSS</span>
      </div>
    </div>    

    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <div class="list-info">
      <span id="totalCount">ì´ 0ê±´</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"><i class="fa-solid fa-file-excel"></i></button>
        <button id="addBtn" class="btn" title="ì¶”ê°€"><i class="fas fa-plus"></i></button>
        <button id="deleteSelectedBtn" class="btn red" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
      </div>
    </div>
    
	<!-- ì‹œì‘ : ê³µí†µ í…Œì´ë¸” êµ¬ì¡° -->
    <div style="position: relative;">
        <div id="globalLoading" class="global-loading-overlay">
            <div class="global-spinner-wrap">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="table-container">
          <table>
            <thead id="headerTable"></thead>
            <tbody id="dataTable"></tbody>
          </table>
        </div>
    </div> 
    
    <div id="pagination" class="pagination"></div>
    <!-- ì¢…ë£Œ : ê³µí†µ í…Œì´ë¸” êµ¬ì¡° -->
    
  </div>
  
</div>

<th:block layout:fragment="pageScript">
<script>
/**
 * âœ… ê¸°ê¸°ë³„ ìµœì í™” ì•± í˜¸ì¶œ í•¨ìˆ˜ (ìˆœì°¨ Fallback ë°©ì‹)
 * 1. ì‹ í˜•/êµ¬í˜• ìŠ¤í‚´ì„ ë°°ì—´ì— ë‹´ì•„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
 * 2. 0.6ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ì•±ì´ ì„¤ì¹˜ëœ ê²½ìš° ì¦‰ì‹œ ë°˜ì‘ ìœ ë„
 */
function openBrokerApp(type, stockCode) {
    if (!stockCode || stockCode.trim() === "") {
        alert("ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const ua = navigator.userAgent.toLowerCase();
    const isAndroid = ua.includes("android");
    const isIos = /iphone|ipad|ipod/.test(ua);

    const urls = [];

    /* ===============================
       1ï¸âƒ£ ì¦ê¶Œì‚¬ë³„ ìŠ¤í‚´ / ì¸í…íŠ¸ í’€ì„¸íŠ¸
       =============================== */
    switch (type) {
        case "mstock":
            // ë¯¸ë˜ì—ì…‹ì¦ê¶Œ (M-STOCK)
            if (isIos) {
                urls.push(`miraeasset-mstock://open?page=1101&code=${stockCode}`); // ì‹ í˜•
                urls.push(`mstock://open?page=1101&code=${stockCode}`);            // êµ¬í˜•
            } else if (isAndroid) {
                // ìµœì‹  í†µí•©ì•± íŒ¨í‚¤ì§€(com.miraeasset.trade) ìš°ì„ ìˆœìœ„
                urls.push(`intent://open?page=1101&code=${stockCode}#Intent;scheme=mstock;package=com.miraeasset.trade;end`);
                urls.push(`mstock://open?page=1101&code=${stockCode}`);
            }
            break;

        case "kiwoom":
            // í‚¤ì›€ì¦ê¶Œ (ì˜ì›…ë¬¸S#)
            if (isIos) {
                urls.push(`kiwoommts://open?page=100&code=${stockCode}`);
            } else if (isAndroid) {
                urls.push(`intent://open?page=100&code=${stockCode}#Intent;scheme=kiwoommts;package=com.pantech.app.kiwoom;end`);
                urls.push(`kiwoommts://open?page=100&code=${stockCode}`);
            }
            break;

        case "toss":
            // í† ìŠ¤ (ì£¼ì‹ ìƒì„¸)
            urls.push(`supertoss://stock/detail?code=${stockCode}`);
            break;

        case "kakao":
            // ì¹´ì¹´ì˜¤í˜ì´ì¦ê¶Œ
            urls.push(`kakaotalk://kakaopay/securities/stock_detail?stock_code=${stockCode}`);
            break;

        case "namu":
            // NHíˆ¬ìì¦ê¶Œ (ë‚˜ë¬´)
            urls.push(`nhqvnamu://open?page=stockDetail&code=${stockCode}`);
            break;

        default:
            // ê¸°ë³¸ê°’ì€ ë¯¸ë˜ì—ì…‹ ì‹ í˜•ìœ¼ë¡œ ì‹œë„
            urls.push(`miraeasset-mstock://open?page=1101&code=${stockCode}`);
    }

    /* ===============================
       2ï¸âƒ£ ì‹¤í–‰ ë¡œì§ (0.6ì´ˆ ê°„ê²© ìˆœì°¨ fallback)
       =============================== */
    let idx = 0;

    const tryOpen = () => {
        // ëª¨ë“  í›„ë³´ ì£¼ì†Œë¥¼ ë‹¤ ì°”ëŸ¬ë´¤ìœ¼ë©´ ì¢…ë£Œ
        if (idx >= urls.length) return;

        const url = urls[idx++];
        console.log(`[App Launch Try ${idx}] : ${url}`);
        
        // ë¸Œë¼ìš°ì € í™”ë©´ ì´ë™ (ì•±ì´ ìˆìœ¼ë©´ ì‹¤í–‰ë˜ê³ , ì—†ìœ¼ë©´ ë³€í™” ì—†ìŒ)
        window.location.href = url;

        // 0.6ì´ˆ ë’¤ì— ë‹¤ìŒ í›„ë³´ ì£¼ì†Œ ì‹¤í–‰ (ì²« ë²ˆì§¸ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ëŒ€ë¹„)
        setTimeout(tryOpen, 600);
    };

    tryOpen();
}


document.addEventListener("DOMContentLoaded", () => {
  initUnifiedList({
    mode: "server", // server or client
    pagination: false,
    apiUrl: "/api/newsRssTypeAList",
    tableBodySelector: "#dataTable",
    paginationSelector: "#pagination",
    searchInputSelector: "#searchInput",
    searchBtnSelector: "#searchBtn",
    addBtnSelector: "#addBtn",
    modalId: "#addModal",
    saveBtnSelector: "#saveBtn",
    closeBtnSelector: "[data-close]",
    checkAllSelector: "#checkAll",
    deleteSelectedBtnSelector: "#deleteSelectedBtn",
    detailModalId: "#detailModal",
    updateBtnSelector: "#updateBtn",
    excelBtnSelector: "#excelBtn",

    excelFileName: "ì—‘ì…€ë¦¬ìŠ¤íŠ¸.xlsx",
    
    columns: [
      { columnId: "id", label: "No", width: "30px", align: "center"},
      { columnId: "stockCode", label: "stockCode", hidden: true},
      { columnId: "stockName", label: "ì¢…ëª©", width: "50px", fontWeight: "400", color: "blue"},
      { columnId: "featureOption", label: "í‚¤ì›Œë“œ", width: "50px", align: "center"},
      { columnId: "title", label: "ì œëª©", width: "300px"}, 
      { columnId: "link", label: "Link", width: "50px", isExternalLink: true, align: "center"},
      { columnId: "mstock", label: "mstock" ,  width: "60px",
    	  align: "center",
          formatter: (val, row) => {
              if (row.stockCode && row.stockCode.length >= 6) {
                  return `
                      <div class="app-dropdown" onclick="event.stopPropagation();">
                          <button class="app-dropbtn">ì•± ì„ íƒ â–¾</button>
                          <div class="app-dropdown-content">
                              <a href="javascript:void(0)" onclick="openBrokerApp('mstock', '${row.stockCode}')">ë¯¸ë˜ì—ì…‹</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('kiwoom', '${row.stockCode}')">í‚¤ì›€ ì˜ì›…ë¬¸</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('kakao', '${row.stockCode}')">ì¹´ì¹´ì˜¤í˜ì´</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('toss', '${row.stockCode}')">í† ìŠ¤ì¦ê¶Œ</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('namu', '${row.stockCode}')">NH ë‚˜ë¬´</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('kb', '${row.stockCode}')">KB M-able</a>
                              <a href="javascript:void(0)" onclick="openBrokerApp('shinhan', '${row.stockCode}')">ì‹ í•œ ì•ŒíŒŒ</a>
                          </div>
                      </div>
                  `;
              }
              return "-";
          } 
      },
      { columnId: "rawDate", label: "ë“±ë¡ì¼", width: "70px" },
      { columnId: "serverStatus", label: "ì„œë²„ ìƒíƒœ", width: "40px", align: "center" }
    ],
    pageSize: 10,
    pageGroupSize: window.pageGroupSize, 
    enableRowClickDetail: false,
    enableDetailView: true,
    buttons: {
      search: true,
      searchInput: true,
      add: false,
      deleteSelected: false,
      excel: false
    },
    detailViewButtons: {
      update: false,
      delete: false
    },
    
    onDetailModalOpen: (id) => console.log("ğŸ” Detail Modal Open:", id),
    
    
 // ğŸ”¥ [ì¶”ê°€ëœ ìœ„ì¹˜] ë°ì´í„° ë Œë”ë§ ì™„ë£Œ í›„ ì‹¤í–‰ë˜ëŠ” ì½œë°±
    onRenderSuccess: () => {
        console.log("âœ… [ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸] ë°ì´í„° ë Œë”ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // ì˜ˆì‹œ: ë Œë”ë§ í›„ íŠ¹ì • ë¡œì§ ì²˜ë¦¬
        const rows = document.querySelectorAll("#dataTable tr");
        rows.forEach(row => {
            // ì˜ˆ: ì œëª©ì— 'ê¸‰ë“±'ì´ í¬í•¨ë˜ë©´ í–‰ ë°°ê²½ìƒ‰ ë…¸ë€ìƒ‰ìœ¼ë¡œ ë³€ê²½
            if (row.innerText.includes("ê¸‰ë“±")) {
                row.style.backgroundColor = "#fffde7";
            }
            
            // ì˜ˆ: ì„œë²„ ìƒíƒœ í…ìŠ¤íŠ¸ì— ë”°ë¼ ë°°ì§€ ìŠ¤íƒ€ì¼ ì…íˆê¸° (DOM ì§ì ‘ ì¡°ì‘)
            const statusCell = row.lastElementChild; 
            if (statusCell && statusCell.innerText.trim() === "OFF") {
                statusCell.innerHTML = `<span style="background: #fee2e2; color: #ef4444; padding: 2px 6px; border-radius: 4px; font-size: 11px;">OFF</span>`;
            } else if (statusCell && statusCell.innerText.trim() === "ON") {
                statusCell.innerHTML = `<span style="background: #dcfce7; color: #22c55e; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ON</span>`;
            }
        });
    },
    
    
  });

  // ì—”í„°í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  if (searchInput && searchBtn) {
      searchInput.addEventListener("keydown", e => {
          if (e.key === "Enter") searchBtn.click(); 
      });
  }

  // ì»¤ìŠ¤í…€ í•„í„° ì˜ˆì‹œ ë¡œì§ (í•„ìš” ì‹œ ì‚¬ìš©)
  const customFilterBtn = document.getElementById("customFilterBtn");
  if (customFilterBtn) {
    customFilterBtn.addEventListener("click", () => {
      unifiedListManager.loadList(0, "web", "filter=active");
    });
  }
  
});
</script>
</th:block>
</body>
</html>