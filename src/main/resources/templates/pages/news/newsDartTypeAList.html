<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>ì „ìê³µì‹œì‹œìŠ¤í…œ-ê³µì‹œ</title>
  <style>
    /* í…Œì´ë¸” ìš°ì¸¡ ê³µë°± ì œê±° ë° ë ˆì´ì•„ì›ƒ ìµœì í™” */
    .table-container table { table-layout: fixed !important; width: 100% !important; }
    .column-title { text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* ì¢…ëª©ëª… ë§í¬ ìŠ¤íƒ€ì¼ */
    .stock-link { color: #2563eb !important; font-weight: bold; text-decoration: underline; cursor: pointer; }
    .stock-link:hover { color: #1d4ed8 !important; }
  </style>
</head>

<body>
<div layout:fragment="content">

  <div class="content-container">
    <div class="page-header">
      <div class="page-title">
        <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ê³µì‹œ</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'"> ë‰´ìŠ¤ / ê³µì‹œ</span>
      </div>
    </div>    

    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
        <button class="btn"><i class="fas fa-filter"></i></button>
        <button class="btn"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>

    <div class="list-info">
      <span id="totalCount">ì´ 0ê±´</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"><i class="fa-solid fa-file-excel"></i></button>
        <button id="addBtn" class="btn" title="ì¶”ê°€"><i class="fas fa-plus"></i></button>
        <button id="deleteSelectedBtn" class="btn red" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
      </div>
    </div>

    <div style="position: relative;">
        <div id="globalLoading" class="global-loading-overlay">
            <div class="global-spinner-wrap"><div class="spinner"></div></div>
        </div>
        <div class="table-container">
          <table>
            <thead id="headerTable"></thead>
            <tbody id="dataTable"></tbody>
          </table>
        </div>
    </div> 
    
    <div id="pagination" class="pagination"></div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
/**
 * âœ… ê¸°ê¸°ë³„ ìµœì í™” ì•± í˜¸ì¶œ í•¨ìˆ˜ (ìˆœì°¨ Fallback ë°©ì‹)
 * 1. ì‹ í˜•/êµ¬í˜• ìŠ¤í‚´ì„ ë°°ì—´ì— ë‹´ì•„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
 * 2. 0.6ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ì•±ì´ ì„¤ì¹˜ëœ ê²½ìš° ì¦‰ì‹œ ë°˜ì‘ ìœ ë„
 */
function openBrokerApp(type, stockCode) {
    if (!stockCode || stockCode.trim() === "") {
        alert("ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const ua = navigator.userAgent.toLowerCase();
    const isAndroid = ua.includes("android");
    const isIos = /iphone|ipad|ipod/.test(ua);

    const urls = [];

    /* ===============================
       1ï¸âƒ£ ì¦ê¶Œì‚¬ë³„ ìŠ¤í‚´ / ì¸í…íŠ¸ í’€ì„¸íŠ¸
       =============================== */
    switch (type) {
        case "mstock":
            // ë¯¸ë˜ì—ì…‹ì¦ê¶Œ (M-STOCK)
            if (isIos) {
                urls.push(`miraeasset-mstock://open?page=1101&code=${stockCode}`); // ì‹ í˜•
                urls.push(`mstock://open?page=1101&code=${stockCode}`);            // êµ¬í˜•
            } else if (isAndroid) {
                // ìµœì‹  í†µí•©ì•± íŒ¨í‚¤ì§€(com.miraeasset.trade) ìš°ì„ ìˆœìœ„
                urls.push(`intent://open?page=1101&code=${stockCode}#Intent;scheme=mstock;package=com.miraeasset.trade;end`);
                urls.push(`mstock://open?page=1101&code=${stockCode}`);
            }
            break;

        case "kiwoom":
            // í‚¤ì›€ì¦ê¶Œ (ì˜ì›…ë¬¸S#)
            if (isIos) {
                urls.push(`kiwoommts://open?page=100&code=${stockCode}`);
            } else if (isAndroid) {
                urls.push(`intent://open?page=100&code=${stockCode}#Intent;scheme=kiwoommts;package=com.pantech.app.kiwoom;end`);
                urls.push(`kiwoommts://open?page=100&code=${stockCode}`);
            }
            break;

        case "toss":
            // í† ìŠ¤ (ì£¼ì‹ ìƒì„¸)
            urls.push(`supertoss://stock/detail?code=${stockCode}`);
            break;

        case "kakao":
            // ì¹´ì¹´ì˜¤í˜ì´ì¦ê¶Œ
            urls.push(`kakaotalk://kakaopay/securities/stock_detail?stock_code=${stockCode}`);
            break;

        case "namu":
            // NHíˆ¬ìì¦ê¶Œ (ë‚˜ë¬´)
            urls.push(`nhqvnamu://open?page=stockDetail&code=${stockCode}`);
            break;

        default:
            // ê¸°ë³¸ê°’ì€ ë¯¸ë˜ì—ì…‹ ì‹ í˜•ìœ¼ë¡œ ì‹œë„
            urls.push(`miraeasset-mstock://open?page=1101&code=${stockCode}`);
    }

    /* ===============================
       2ï¸âƒ£ ì‹¤í–‰ ë¡œì§ (0.6ì´ˆ ê°„ê²© ìˆœì°¨ fallback)
       =============================== */
    let idx = 0;

    const tryOpen = () => {
        // ëª¨ë“  í›„ë³´ ì£¼ì†Œë¥¼ ë‹¤ ì°”ëŸ¬ë´¤ìœ¼ë©´ ì¢…ë£Œ
        if (idx >= urls.length) return;

        const url = urls[idx++];
        console.log(`[App Launch Try ${idx}] : ${url}`);
        
        // ë¸Œë¼ìš°ì € í™”ë©´ ì´ë™ (ì•±ì´ ìˆìœ¼ë©´ ì‹¤í–‰ë˜ê³ , ì—†ìœ¼ë©´ ë³€í™” ì—†ìŒ)
        window.location.href = url;

        // 0.6ì´ˆ ë’¤ì— ë‹¤ìŒ í›„ë³´ ì£¼ì†Œ ì‹¤í–‰ (ì²« ë²ˆì§¸ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ëŒ€ë¹„)
        setTimeout(tryOpen, 600);
    };

    tryOpen();
}

document.addEventListener("DOMContentLoaded", () => {
  initUnifiedList({
      mode: "server",
      pagination: true,
      apiUrl: "/api/newsDartTypeAList",
      tableBodySelector: "#dataTable",
      paginationSelector: "#pagination",
      searchInputSelector: "#searchInput",
      searchBtnSelector: "#searchBtn",
      excelBtnSelector: "#excelBtn",
      excelFileName: "ê³µì‹œë¦¬ìŠ¤íŠ¸.xlsx",
      
      columns: [
        { columnId: "id", label: "No" , align: "center", width: "50px"},
        { columnId: "stockCode", label: "stockCode", hidden: true},
        
        // ğŸš© íšŒì‚¬ëª… í´ë¦­ ì‹œ ì•„ì´í°/ì•ˆë“œë¡œì´ë“œ ì¦‰ì‹œ ì‹¤í–‰
        { columnId: "stockName", label: "íšŒì‚¬ëª…", width: "80px", align: "left",
          /*   formatter: (val, row) => {
                if (row.stockCode) {
                    return `<span class="stock-link" onclick="openBrokerApp('mstock', '${row.stockCode}')">${val}</span>`;
                }
                return val;
            } */
        },
        
        { columnId: "featureOption", label: "ì¬ë¬´ìƒíƒœ" , align: "center", width: "80px",
            formatter: (val, row) => {
                if (!val || val.includes("ì¬ë¬´ë¯¸í™•ì¸")) return `<span class="badge" style="background:#ccc; color:#fff">ë¯¸í™•ì¸</span>`;
                if (val.includes("í‘ì")) return `<b style="color:#e74c3c;"><i class="fa-solid fa-caret-up"></i> ${val}</b>`;
                if (val.includes("ì ì")) return `<b style="color:#3498db;"><i class="fa-solid fa-caret-down"></i> ${val}</b>`;
                return val;
            }  
        },
        
        // ğŸš© ì œëª© ìœ ë™ ë„ˆë¹„ (ìš°ì¸¡ ê³µë°± ì œê±°)
        { columnId: "title", label: "ê³µì‹œì œëª©" , width: "140px", className: "column-title" },
        
        { columnId: "link", label: "ë§í¬" , isExternalLink:true, width: "50px", align: "center"},
        { columnId: "mstock", label: "ì•±" ,  width: "50px", align: "center",
            formatter: (val, row) => {
                if (row.stockCode && row.stockCode.length >= 6) {
                    return `
                        <div class="app-dropdown" onclick="event.stopPropagation();">
                            <button class="app-dropbtn">ì„ íƒ â–¾</button>
                            <div class="app-dropdown-content">
                                <a href="javascript:void(0)" onclick="openBrokerApp('mstock', '${row.stockCode}')">ë¯¸ë˜ì—ì…‹</a>
                                <a href="javascript:void(0)" onclick="openBrokerApp('kiwoom', '${row.stockCode}')">í‚¤ì›€</a>
                                <a href="javascript:void(0)" onclick="openBrokerApp('toss', '${row.stockCode}')">í† ìŠ¤</a>
                                <a href="javascript:void(0)" onclick="openBrokerApp('kakao', '${row.stockCode}')">ì¹´ì¹´ì˜¤</a>
                            </div>
                        </div>
                    `;
                }
                return "-";
            } 
        },
        { columnId: "serverStatus", label: "ì‹œì¥" , align: "center", width: "50px"},
        { columnId: "rawDate", label: "ì ‘ìˆ˜ì¼" , align: "center", width: "80px"}
      ],
      pageSize: 15,
      pageGroupSize: window.pageGroupSize, 
      enableRowClickDetail: false,
      enableDetailView: false,
      buttons: { search: true, searchInput: true, add: false, deleteSelected: false, excel: false }
  });

  // ì—”í„°í‚¤ ê²€ìƒ‰
  const searchInput = document.getElementById("searchInput");
  if(searchInput) {
      searchInput.addEventListener("keydown", e => { if (e.key === "Enter") document.getElementById("searchBtn").click(); });
  }
});
</script>
</th:block>
</body>
</html>