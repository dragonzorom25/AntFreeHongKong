<!-- menuAuth.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <title>ê¶Œí•œ ë° ë©”ë‰´ ê´€ë¦¬ - MyBaseLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #dcdfe6;
            --text-main: #303133;
            --text-sub: #606266;
            --hover-bg: #f5f7fa;
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --danger-color: #f56c6c;
            --success-color: #67c23a;
        }

        .admin-wrapper {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 150px);
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            max-height: 800px;
            position: relative;
        }

        /* ë¯¸ì‚¬ìš© ê·¸ë£¹ ì„ íƒ ì‹œ íŒ¨ë„ ë¹„í™œì„±í™” íš¨ê³¼ */
        .panel.disabled-overlay::after {
            content: "ë¯¸ì‚¬ìš© ìƒíƒœì˜ ê·¸ë£¹ì€ ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            position: absolute;
            top: 60px; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--danger-color);
            backdrop-filter: blur(1px);
            border-radius: 0 0 12px 12px;
        }

        .panel-header {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            border-radius: 12px 12px 0 0;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* ê¶Œí•œ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .role-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .role-item {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
            position: relative;
            background: #fff;
        }

        .role-item:hover { background-color: var(--hover-bg); }

        .role-item.active {
            background-color: #ecf5ff;
            border-color: #b3d8ff;
            color: var(--primary-color);
            font-weight: bold;
        }

        .role-item.inactive {
            opacity: 0.6;
            background-color: #fcfcfc;
        }

        .role-info { flex: 1; }
        .role-info .name-area { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .role-info .name { font-size: 1rem; }
        .role-info .desc { font-size: 0.85rem; color: var(--text-sub); font-weight: normal; }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-badge.n { background: #fef0f0; color: var(--danger-color); border: 1px solid #fde2e2; }
        .status-badge.y { background: #f0f9eb; color: var(--success-color); border: 1px solid #e1f3d8; }

        .role-actions {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }

        .btn-icon {
            background: none; border: none; color: var(--text-sub);
            cursor: pointer; padding: 5px; transition: color 0.2s;
        }
        .btn-icon:hover { color: var(--primary-color); }

        /* âœ… ë©”ë‰´ íŠ¸ë¦¬ ìŠ¤íƒ€ì¼ (ì™¼ìª½ ì •ë ¬ ë° ìš”ì†Œ ìˆœì„œ ë³€ê²½) */
        #treeContainer {
            width: 100%;
        }

        .menu-tree { 
            list-style: none; 
            padding-left: 0; 
            margin: 0; 
        }

        .tree-item { 
            margin: 4px 0; 
        }

        .tree-node {
            display: flex; 
            align-items: center; 
            padding: 8px 12px; 
            border-radius: 6px; 
            transition: background 0.2s; 
            background: #fff; 
            cursor: pointer; 
            user-select: none;
            border: 1px solid #eee;
            /* í…ìŠ¤íŠ¸(ì™¼ìª½) --- ì²´í¬ë°•ìŠ¤(ì˜¤ë¥¸ìª½) ë°°ì¹˜ë¥¼ ìœ„í•œ flex ì„¤ì • */
            justify-content: space-between; 
            width: 100%;
            box-sizing: border-box;
        }
        
        .tree-node:hover { 
            background-color: var(--hover-bg);
            border-color: var(--border-color);
        }

        /* í…ìŠ¤íŠ¸ì™€ ì•„ì´ì½˜ì„ ê°ì‹¸ëŠ” ì™¼ìª½ ì˜ì—­ */
        .node-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tree-node input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            cursor: pointer; 
            margin: 0;
            accent-color: var(--primary-color);
            order: 2; /* ì²´í¬ë°•ìŠ¤ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
        }

        .toggle-icon {
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: transform 0.2s; 
            color: var(--text-sub);
        }
        .tree-item.collapsed .toggle-icon { transform: rotate(-90deg); }

        /* í•˜ìœ„ ë©”ë‰´ ë“¤ì—¬ì“°ê¸° */
        .tree-children {
            padding-left: 24px; 
            margin-top: 2px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .tree-item.collapsed .tree-children { 
            max-height: 0 !important; 
        }

        .icon-box {
            width: 20px;
            display: flex;
            justify-content: center;
            color: var(--text-sub);
        }

        .btn {
            padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer;
            font-weight: 500; font-size: 0.9rem; white-space: nowrap; transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-save { background: var(--primary-color); color: white; }
        .btn-save:hover { background: #357abd; }
        .btn-cancel { background: #f2f6fc; color: #606266; margin-right: 8px; }

        .empty-state {
            width: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 200px; color: var(--text-sub); text-align: center;
        }

        /* ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg); display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: #fff; padding: 25px; border-radius: 15px; width: 100%; max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-family: inherit;
        }
        .form-group textarea { height: 80px; resize: none; }

        .modal-footer { display: flex; justify-content: flex-end; margin-top: 25px; }

        @media (max-width: 1024px) {
            .admin-wrapper { grid-template-columns: 1fr; height: auto; }
            .panel { max-height: none; }
            .panel-body { overflow-y: visible; }
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="content-container">
        <!-- ìƒë‹¨ í—¤ë” ì„¹ì…˜ -->
        <div class="page-header">
            <div class="page-title">
                <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¶Œí•œ ë° ë©”ë‰´ ê´€ë¦¬'">ğŸ“„ ê¶Œí•œ ë° ë©”ë‰´ ê´€ë¦¬</h2>
            </div>
            <div class="breadcrumb">
                <i class="fas fa-folder-open"></i>
                <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ ê´€ë¦¬ / ê¶Œí•œ ë° ë©”ë‰´ ê´€ë¦¬'">ì‹œìŠ¤í…œ ê´€ë¦¬ / ê¶Œí•œ ë° ë©”ë‰´ ê´€ë¦¬</span>
            </div>
        </div>

        <div class="admin-wrapper">
            <!-- ì¢Œì¸¡: ê¶Œí•œ ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸ -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-shield-alt"></i> ê¶Œí•œ ê·¸ë£¹</h3>
                    <button class="btn btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openModal('ADD')">ê·¸ë£¹ì¶”ê°€</button>
                </div>
                <div class="panel-body">
                    <ul class="role-list" id="roleList"></ul>
                </div>
            </div>

            <!-- ìš°ì¸¡: ë©”ë‰´ íŠ¸ë¦¬ -->
            <div class="panel" id="menuPanel">
                <div class="panel-header">
                    <h3><i class="fas fa-sitemap"></i> ì ‘ê·¼ ì„¤ì • <span id="selectedRoleName" style="color:var(--primary-color); margin-left:5px;"></span></h3>
                    <button class="btn btn-save" onclick="savePrivileges()" id="mainSaveBtn">ì €ì¥</button>
                </div>
                <div class="panel-body">
                    <div id="treeContainer">
                        <div class="empty-state">
                            <i class="fas fa-arrow-left fa-3x" style="margin-bottom:15px;"></i>
                            <p>ê¶Œí•œ ê·¸ë£¹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê·¸ë£¹ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="roleModal">
        <div class="modal-content">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h4 id="modalTitle" style="margin:0;"><i class="fas fa-plus-circle"></i> ê¶Œí•œ ê·¸ë£¹ ì¶”ê°€</h4>
            </div>
            <div class="form-group">
                <label>ê·¸ë£¹ëª… (ROLE NAME)</label>
                <input type="text" id="newRoleName" placeholder="ì˜ˆ: MANAGER, EDITOR">
            </div>
            <div class="form-group">
                <label>ì‚¬ìš© ìœ ë¬´</label>
                <select id="newRoleStatus">
                    <option value="Y">ì‚¬ìš© (Active)</option>
                    <option value="N">ë¯¸ì‚¬ìš© (Inactive)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ìƒì„¸ ì„¤ëª…</label>
                <textarea id="newRoleDesc" placeholder="ì´ ê·¸ë£¹ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="handleSaveRole()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="pageScript">
<script>
    // 1. ì´ˆê¸° ë°ì´í„°
    let mockRoles = [
        { id: 1, name: 'ADMIN', description: 'ì „ì²´ ì‹œìŠ¤í…œ ê´€ë¦¬ì', status: 'Y' },
        { id: 2, name: 'USER', description: 'ì¼ë°˜ ë‰´ìŠ¤ ì´ìš©ì', status: 'Y' },
        { id: 3, name: 'MANAGER', description: 'ë‰´ìŠ¤ í¸ì§‘ ë° ê´€ë¦¬ì', status: 'N' }
    ];

    const mockMenus = [
        {
            id: 10, name: 'ë‰´ìŠ¤ ê´€ë¦¬', icon: 'fas fa-newspaper', 
            children: [
                { id: 11, name: 'RSS í†µí•© ë‰´ìŠ¤', icon: 'fas fa-rss' },
                { id: 12, name: 'DART ê³µì‹œ ë¦¬ìŠ¤íŠ¸', icon: 'fas fa-file-contract' }
            ]
        },
        {
            id: 20, name: 'ì‹œìŠ¤í…œ ê´€ë¦¬', icon: 'fas fa-cog', 
            children: [
                { id: 21, name: 'ì‚¬ìš©ì ê´€ë¦¬', icon: 'fas fa-users' },
                { id: 22, name: 'ë©”ë‰´/ê¶Œí•œ ê´€ë¦¬', icon: 'fas fa-shield-alt' }
            ]
        }
    ];

    let roleMenuMapping = { 1: [10, 11, 12, 20, 21, 22], 2: [10, 11], 3: [10, 11, 12] };
    let currentSelectedRoleId = null;
    let modalMode = 'ADD';
    let editingRoleId = null;

    document.addEventListener("DOMContentLoaded", () => {
        initRoles();
    });

    function initRoles() {
        const roleList = document.getElementById('roleList');
        if (!roleList) return;
        roleList.innerHTML = mockRoles.map(role => `
            <li class="role-item ${currentSelectedRoleId === role.id ? 'active' : ''} ${role.status === 'N' ? 'inactive' : ''}" 
                id="role-${role.id}" onclick="selectRole(${role.id})">
                <div class="role-info">
                    <div class="name-area">
                        <span class="name">${role.name}</span>
                        <span class="status-badge ${role.status.toLowerCase()}">${role.status === 'Y' ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©'}</span>
                    </div>
                    <span class="desc">${role.description}</span>
                </div>
                <div class="role-actions">
                    <button class="btn-icon" title="ìˆ˜ì •" onclick="event.stopPropagation(); openModal('EDIT', ${role.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <i class="fas fa-chevron-right" style="font-size: 0.8rem; opacity: 0.5;"></i>
                </div>
            </li>
        `).join('');
    }

    function openModal(mode, roleId = null) {
        modalMode = mode;
        editingRoleId = roleId;
        const nameInput = document.getElementById('newRoleName');
        const descInput = document.getElementById('newRoleDesc');
        const statusSelect = document.getElementById('newRoleStatus');

        if (mode === 'EDIT') {
            const role = mockRoles.find(r => r.id === roleId);
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> ê¶Œí•œ ê·¸ë£¹ ìˆ˜ì •';
            nameInput.value = role.name;
            descInput.value = role.description;
            statusSelect.value = role.status;
        } else {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> ê¶Œí•œ ê·¸ë£¹ ì¶”ê°€';
            nameInput.value = ''; descInput.value = ''; statusSelect.value = 'Y';
        }
        document.getElementById('roleModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('roleModal').style.display = 'none'; }

    function handleSaveRole() {
        const nameVal = document.getElementById('newRoleName').value.trim();
        const statusVal = document.getElementById('newRoleStatus').value;
        const descVal = document.getElementById('newRoleDesc').value.trim();

        if (!nameVal) { alert('ê·¸ë£¹ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        if (modalMode === 'EDIT') {
            const role = mockRoles.find(r => r.id === editingRoleId);
            if (role) {
                role.name = nameVal.toUpperCase();
                role.status = statusVal;
                role.description = descVal;
            }
        } else {
            const newId = mockRoles.length > 0 ? Math.max(...mockRoles.map(r => r.id)) + 1 : 1;
            mockRoles.push({ id: newId, name: nameVal.toUpperCase(), description: descVal, status: statusVal });
            roleMenuMapping[newId] = [];
            editingRoleId = newId;
        }

        initRoles();
        closeModal();
        selectRole(editingRoleId || currentSelectedRoleId);
    }

    function selectRole(roleId) {
        if(!roleId) return;
        currentSelectedRoleId = roleId;
        const role = mockRoles.find(r => r.id === roleId);
        
        document.getElementById('selectedRoleName').innerText = `[${role.name}]`;
        document.querySelectorAll('.role-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`role-${roleId}`)?.classList.add('active');

        const menuPanel = document.getElementById('menuPanel');
        if (role.status === 'N') {
            menuPanel.classList.add('disabled-overlay');
            document.getElementById('mainSaveBtn').disabled = true;
        } else {
            menuPanel.classList.remove('disabled-overlay');
            document.getElementById('mainSaveBtn').disabled = false;
        }

        renderMenuTree(roleId);
    }

    function renderMenuTree(roleId) {
        const container = document.getElementById('treeContainer');
        const allowedMenus = roleMenuMapping[roleId] || [];

        function buildTree(menus) {
            let html = '<ul class="menu-tree">';
            menus.forEach(menu => {
                const isChecked = allowedMenus.includes(menu.id) ? 'checked' : '';
                const hasChildren = menu.children && menu.children.length > 0;
                
                // âœ… ìˆ˜ì •ëœ ë…¸ë“œ êµ¬ì¡°: ì™¼ìª½(ì•„ì´ì½˜+í…ìŠ¤íŠ¸) | ì˜¤ë¥¸ìª½(ì²´í¬ë°•ìŠ¤)
                html += `
                    <li class="tree-item" id="item-${menu.id}">
                        <div class="tree-node" onclick="handleNodeClick(event, ${menu.id}, ${hasChildren})">
                            <div class="node-left">
                                <div class="toggle-icon" style="${!hasChildren ? 'opacity:0; pointer-events:none;' : ''}">
                                    <i class="fas fa-caret-down"></i>
                                </div>
                                <div class="icon-box"><i class="${menu.icon}"></i></div>
                                <span style="font-weight: ${hasChildren ? 'bold' : 'normal'}">${menu.name}</span>
                            </div>
                            <input type="checkbox" id="chk-${menu.id}" ${isChecked} onclick="event.stopPropagation(); toggleChild(${menu.id}, this.checked)">
                        </div>
                        ${hasChildren ? `<div class="tree-children" id="child-container-${menu.id}">${buildTree(menu.children)}</div>` : ''}
                    </li>`;
            });
            return html + '</ul>';
        }
        container.innerHTML = buildTree(mockMenus);
    }

    function handleNodeClick(e, menuId, hasChildren) {
        if (!hasChildren) return;
        const item = document.getElementById(`item-${menuId}`);
        const content = document.getElementById(`child-container-${menuId}`);
        const isCollapsed = item.classList.toggle('collapsed');
        
        if (isCollapsed) {
            content.style.maxHeight = content.scrollHeight + "px";
            content.offsetHeight;
            content.style.maxHeight = "0";
        } else {
            content.style.maxHeight = content.scrollHeight + "px";
            content.addEventListener('transitionend', function cb(e) {
                if (e.propertyName === 'max-height' && !item.classList.contains('collapsed')) {
                    content.style.maxHeight = "none";
                    content.removeEventListener('transitionend', cb);
                }
            });
        }
    }

    function toggleChild(parentId, isChecked) {
        const container = document.getElementById(`child-container-${parentId}`);
        if (container) {
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
        }
    }

    function savePrivileges() {
        const role = mockRoles.find(r => r.id === currentSelectedRoleId);
        if (!role || role.status === 'N') return;
        
        const selectedIds = Array.from(document.querySelectorAll('#treeContainer input[type="checkbox"]:checked'))
                                .map(cb => parseInt(cb.id.replace('chk-', '')));
        roleMenuMapping[currentSelectedRoleId] = selectedIds;
        alert(`[${role.name}] ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
</script>
</th:block>

</body>
</html>