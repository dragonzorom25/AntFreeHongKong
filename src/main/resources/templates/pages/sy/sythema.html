<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>주식 테마 관리 - MyBaseLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ✅ 권한 관리(menuAuth.html) 스타일 테마 적용 */
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #dcdfe6;
            --text-main: #303133;
            --text-sub: #606266;
            --hover-bg: #f5f7fa;
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --danger-color: #f56c6c;
            --success-color: #67c23a;
            --excel-color: #1d6f42;
        }

        /* 🧾 레이아웃 구조 통합 */
        .admin-wrapper {
            display: grid;
            grid-template-columns: 320px 1fr; /* 좌측 테마 리스트 고정 */
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 180px);
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            max-height: 800px;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 { margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; }

        .panel-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* 📋 좌측 테마 리스트 (role-item 스타일 적용) */
        .theme-list { list-style: none; padding: 0; margin: 0; }
        .theme-item {
            padding: 15px; border-radius: 8px; cursor: pointer; margin-bottom: 8px;
            transition: all 0.2s; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .theme-item:hover { background-color: var(--hover-bg); }
        .theme-item.active { background-color: #ecf5ff; border-color: #b3d8ff; color: var(--primary-color); font-weight: bold; }

        /* 📊 테이블 스타일 (기존 v2.7 table 스타일 통합) */
        .stock-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .stock-table th, .stock-table td { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 13px; text-align: center; }
        .stock-table th { background: #f8f9fb; font-weight: 600; }
        .col-no { width: 50px; }
        .col-name { text-align: left !important; }
        .col-code { width: 100px; color: var(--primary-color); }
        .col-del { width: 60px; }

        /* 🔘 버튼 공통 스타일 */
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .btn-excel { background: var(--excel-color); color: white; }
        .btn-add { background: var(--primary-color); color: white; }
        .btn-save { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-search { background: #5c6bc0; color: white; }

        /* 📦 모달 & 기타 */
        .modal-overlay { position: fixed; inset: 0; background: var(--overlay-bg); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; }
        .theme-title-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #bbb; gap: 10px; }

        @media (max-width: 1024px) { .admin-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="content-container">
        <div class="page-header">
            <div class="page-title">
                <h2 th:text="${pageTitle} ?: '📊 주식 테마 관리'">📊 주식 테마 관리</h2>
            </div>
            <div class="breadcrumb">
                <i class="fas fa-folder-open"></i>
                <span th:text="${breadcrumb} ?: '주식 서비스 / 주식 테마 관리'">주식 서비스 / 주식 테마 관리</span>
            </div>
        </div>

        <div class="admin-wrapper">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-tags"></i> 테마 리스트</h3>
                    <button class="btn btn-add" style="padding: 5px 10px; font-size: 0.75rem;" onclick="openThemeModal()">추가</button>
                </div>
                <div class="panel-body">
                    <ul class="theme-list" id="dropdownList"></ul>
                </div>
            </div>

            <div class="panel" id="detailPanel">
                <div class="panel-header">
                    <h3><i class="fas fa-list-ul"></i> 종목 관리 <span id="curLabel" style="color:var(--primary-color); margin-left:5px;"></span></h3>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-excel" onclick="openExcelModal()"><i class="fa-solid fa-file-excel"></i> 엑셀</button>
                        <button class="btn btn-save" onclick="saveData()"><i class="fas fa-save"></i> 저장</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="emptyPanel" class="empty-state">
                        <i class="fas fa-arrow-left fa-3x"></i>
                        <p>관리할 테마를 왼쪽에서 선택해 주세요.</p>
                    </div>

                    <div id="contentArea" style="display: none;">
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="editThemeName" class="theme-title-input" style="margin:0; flex:1;" placeholder="테마명">
                            <button class="btn btn-search" onclick="openSearchModal()"><i class="fas fa-plus"></i> 종목추가</button>
                            <button class="btn btn-danger" onclick="deleteTheme()"><i class="fas fa-trash"></i> 테마삭제</button>
                        </div>
                        <div class="table-wrapper">
                            <table class="stock-table">
                                <thead>
                                    <tr>
                                        <th class="col-no">No</th>
                                        <th class="col-name">종목명</th>
                                        <th class="col-code">코드</th>
                                        <th class="col-del">삭제</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="excelModal">
        <div class="modal-content">
            <h4><i class="fa-solid fa-file-excel"></i> 엑셀 종목 업로드</h4>
            <div style="margin: 20px 0; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; text-align: center;">
                <input type="file" id="excelFileInput" accept=".xlsx, .xls">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-save" style="flex:1" onclick="handleExcelUpload()">업로드</button>
                <button class="btn btn-danger" style="flex:1; background:#999;" onclick="closeModal()">취소</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="searchModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0;"><i class="fas fa-search"></i> 종목 검색</h4>
                <i class="fas fa-times" style="cursor:pointer" onclick="closeModal()"></i>
            </div>
            <input type="text" id="searchInput" class="theme-title-input" placeholder="종목명 또는 코드" oninput="filterStock(this.value)">
            <div id="searchResult" style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="themeModal">
        <div class="modal-content">
            <h4><i class="fas fa-plus-circle"></i> 새 테마 생성</h4>
            <input type="text" id="nT" class="theme-title-input" placeholder="테마명을 입력하세요">
            <button class="btn btn-add" style="width:100%; justify-content:center;" onclick="addT()">생성하기</button>
        </div>
    </div>
</div>

<th:block layout:fragment="pageScript">
<script th:inline="javascript">
    // 🚩 원본 주석 및 데이터 유지
    const stockMaster = [
        {n:"삼성전자", c:"005930"}, {n:"SK하이닉스", c:"000660"}, {n:"에코프로", c:"086520"},
        {n:"에코프로비엠", c:"247540"}, {n:"포스코홀딩스", c:"005490"}, {n:"현대차", c:"005380"}
    ];

    let themeData = { "2차전지": [{n:"에코프로", c:"086520"}] };
    let currentTheme = null;

    document.addEventListener("DOMContentLoaded", () => {
        renderThemeList();
    });

    function renderThemeList() {
        const list = document.getElementById('dropdownList');
        list.innerHTML = Object.keys(themeData).sort().map(k => `
            <li class="theme-item ${currentTheme === k ? 'active' : ''}" onclick="selectTheme('${k}')">
                <span>${k}</span>
                <i class="fas fa-chevron-right" style="opacity:0.3"></i>
            </li>
        `).join('');
    }

    function selectTheme(k) {
        currentTheme = k;
        document.getElementById('curLabel').innerText = `[${k}]`;
        document.getElementById('emptyPanel').style.display = 'none';
        document.getElementById('contentArea').style.display = 'block';
        document.getElementById('editThemeName').value = k;
        renderThemeList();
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('stockTableBody');
        const items = themeData[currentTheme] || [];
        tbody.innerHTML = items.map((v, i) => `
            <tr>
                <td class="col-no">${i+1}</td>
                <td class="col-name">${v.n}</td>
                <td class="col-code">${v.c}</td>
                <td class="col-del"><i class="fas fa-trash-alt" style="color:red; cursor:pointer" onclick="removeStock('${v.n}')"></i></td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="padding:40px; color:#ccc;">등록된 종목이 없습니다.</td></tr>';
    }

    function filterStock(v) {
        const resDiv = document.getElementById('searchResult');
        if(!v.trim()) { resDiv.innerHTML = ''; return; }
        const filtered = stockMaster.filter(s => s.n.includes(v) || s.c.includes(v));
        resDiv.innerHTML = filtered.map(s => `
            <div style="padding:12px; border-bottom:1px solid #f9f9f9; cursor:pointer; display:flex; justify-content:space-between;" onclick="addStockFromSearch('${s.n}', '${s.c}')">
                <span>${s.n}</span><span style="color:#4a90e2">${s.c}</span>
            </div>
        `).join('') || '<div style="padding:20px; text-align:center; color:#999;">결과 없음</div>';
    }

    function addStockFromSearch(n, c) {
        if(!themeData[currentTheme].some(x => x.n === n)) {
            themeData[currentTheme].push({n, c});
            renderTable();
            closeModal();
        } else { alert('이미 있는 종목!'); }
    }

    function removeStock(n) { themeData[currentTheme] = themeData[currentTheme].filter(x => x.n !== n); renderTable(); }
    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
    function openExcelModal() { if(!currentTheme) return alert('테마를 먼저 선택하세요!'); document.getElementById('excelModal').style.display='flex'; }
    function openThemeModal() { document.getElementById('themeModal').style.display='flex'; }
    function addT() { const v = document.getElementById('nT').value; if(v){ themeData[v]=[]; selectTheme(v); closeModal(); } }
    function saveData() { alert('데이터가 성공적으로 저장되었습니다.'); }
    function deleteTheme() { if(confirm('이 테마를 삭제하시겠습니까?')) { delete themeData[currentTheme]; location.reload(); } }
    function handleExcelUpload() { alert('엑셀 데이터 분석을 시작합니다.'); closeModal(); }
    function openSearchModal() { document.getElementById('searchModal').style.display='flex'; document.getElementById('searchInput').focus(); }
</script>
</th:block>
</body>
</html>