<div th:fragment="bottomFragment">
  <div class="bottom-info-bar">
    <div class="info-bar-content">
      <div class="info-main-scroll">
        <div class="info-group">
          <span class="label-text">ë‚˜ìŠ¤ë‹¥</span>
          <span class="value-text" id="val-nasdaq">
            <th:block th:if="${stockIndices != null && stockIndices.NASDAQ != null}">
              <span th:text="${stockIndices.NASDAQ}">-</span>
              <span th:class="${stockIndices.NASDAQ_TYPE == 'up' ? 'up-color' : 'down-color'}" 
                    th:text="${stockIndices.NASDAQ_TYPE == 'up' ? 'â–²' : 'â–¼'}">â–²</span>
            </th:block>
            <th:block th:unless="${stockIndices != null && stockIndices.NASDAQ != null}">- <span class="up-color">â–²</span></th:block>
          </span>
        </div>

        <div class="info-group">
          <span class="label-text">ë‹¤ìš°</span>
          <span class="value-text" id="val-dow">
            <th:block th:if="${stockIndices != null && stockIndices.DOW != null}">
              <span th:text="${stockIndices.DOW}">-</span>
              <span th:class="${stockIndices.DOW_TYPE == 'up' ? 'up-color' : 'down-color'}" 
                    th:text="${stockIndices.DOW_TYPE == 'up' ? 'â–²' : 'â–¼'}">â–²</span>
            </th:block>
            <th:block th:unless="${stockIndices != null && stockIndices.DOW != null}">- <span class="up-color">â–²</span></th:block>
          </span>
        </div>

        <div class="info-group">
          <span class="label-text">ì½”ìŠ¤í”¼</span>
          <span class="value-text" id="val-kospi">
            <th:block th:if="${stockIndices != null && stockIndices.KOSPI != null}">
              <span th:text="${stockIndices.KOSPI}">-</span>
              <span th:class="${stockIndices.KOSPI_TYPE == 'up' ? 'up-color' : 'down-color'}" 
                    th:text="${stockIndices.KOSPI_TYPE == 'up' ? 'â–²' : 'â–¼'}">â–¼</span>
            </th:block>
            <th:block th:unless="${stockIndices != null && stockIndices.KOSPI != null}">- <span class="down-color">â–¼</span></th:block>
          </span>
        </div>

        <div class="info-group">
          <span class="label-text">ì½”ìŠ¤ë‹¥</span>
          <span class="value-text" id="val-kosdaq">
            <th:block th:if="${stockIndices != null && stockIndices.KOSDAQ != null}">
              <span th:text="${stockIndices.KOSDAQ}">-</span>
              <span th:class="${stockIndices.KOSDAQ_TYPE == 'up' ? 'up-color' : 'down-color'}" 
                    th:text="${stockIndices.KOSDAQ_TYPE == 'up' ? 'â–²' : 'â–¼'}">â–²</span>
            </th:block>
            <th:block th:unless="${stockIndices != null && stockIndices.KOSDAQ != null}">- <span class="up-color">â–²</span></th:block>
          </span>
        </div>
      </div>
      
      <div class="info-control-group">
        <div class="info-group update-group">
          <span class="label-text"><i class="fa-regular fa-clock" style="font-size: 6px;"></i></span>
          <span class="value-text" id="val-time" th:text="${stockIndices != null ? stockIndices.updateTime : 'ì‹¤ì‹œê°„'}">00:00</span>
        </div>
        <div class="refresh-btn" id="btn-refresh-info" title="ì •ë³´ ì—…ë°ì´íŠ¸" onclick="handleExchangeRefresh(event)">
          <i id="refresh-icon" class="fa-solid fa-rotate-right"></i>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer-bar">
    <span>Â© <span id="currentYear"></span> MyBaseLink Inc. All Rights Reserved.</span>
  </footer>

  <style>
    .bottom-info-bar {
      position: fixed;
      bottom: 30px; 
      left: 0;
      width: 100%;
      height: 32px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      z-index: 2400;
      display: flex;
      align-items: center;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.03);
    }
    .info-bar-content { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 10px; gap: 5px; }
    .info-main-scroll { display: flex; flex-wrap: nowrap; gap: 20px; overflow-x: auto; scrollbar-width: none; flex: 1; }
    .info-main-scroll::-webkit-scrollbar { display: none; }
    .info-control-group { display: flex; align-items: center; gap: 5px; flex-shrink: 0; border-left: 1px solid #f1f5f9; padding-left: 10px; }
    .info-group { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
    .label-text { color: #64748b; font-weight: 800; font-size: 7.5px; letter-spacing: -0.04em; }
    .value-text { color: #334155; font-weight: 700; font-size: 7px; font-family: 'Inter', sans-serif; }
    .up-color { color: #ef4444; font-size: 5.5px; }
    .down-color { color: #3b82f6; font-size: 5.5px; }
    .refresh-btn { cursor: pointer; color: #94a3b8; font-size: 8px; display: flex; align-items: center; padding: 2px; }
    .spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; color: #9ca3af; font-size: 8px; display: flex; align-items: center; justify-content: center; z-index: 2500; }
    body.dark-mode .bottom-info-bar { background: #1e293b; border-top-color: #334155; }
    body.dark-mode .footer-bar { background: #0f172a; border-top-color: #1e293b; color: #64748b; }
    body.dark-mode .label-text { color: #94a3b8; }
    body.dark-mode .value-text { color: #f1f5f9; }
  </style>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        // 1. í•˜ë‹¨ ì¹´í”¼ë¼ì´íŠ¸ ì—°ë„ ì„¸íŒ…
        const yearEl = document.getElementById("currentYear");
        if(yearEl) yearEl.textContent = new Date().getFullYear();
        
        // 2. íŽ˜ì´ì§€ ì—´ë¦¬ìžë§ˆìž ì²« ë°ì´í„° ìˆ˜ì§‘
        handleExchangeRefresh();

        // 3. ðŸš© 1ë¶„(60000ms)ë§ˆë‹¤ ìžë™ìœ¼ë¡œ ì§€ìˆ˜ ê°±ì‹ 
        setInterval(() => {
            handleExchangeRefresh();
        }, 60000); 
    });

    (function initStockBar() {
        let __isFetching = false; 

        window.handleExchangeRefresh = async function(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            if (__isFetching) return;

            const icon = document.getElementById('refresh-icon');
            const btn = document.getElementById('btn-refresh-info');
            __isFetching = true;
            
            if (icon) icon.classList.add('spinning');
            if (btn) btn.style.opacity = '0.5';

            try {
                const response = await fetch('/api/exchange/latest?nocache=' + Date.now());
                if (!response.ok) throw new Error('API í†µì‹  ì‹¤íŒ¨');
                
                const data = await response.json();
                
                const updateIndex = (id, value, type) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!value || value === "0" || value === "null") return;
                    
                    const isUp = (type === 'up' || type === '1' || type === '2');
                    const colorClass = isUp ? 'up-color' : 'down-color';
                    const iconMark = isUp ? 'â–²' : 'â–¼';
                    
                    const formattedVal = String(value).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    el.innerHTML = `${formattedVal} <span class="${colorClass}">${iconMark}</span>`;
                };

                updateIndex('val-nasdaq', data.NASDAQ, data.NASDAQ_TYPE);
                updateIndex('val-dow', data.DOW, data.DOW_TYPE);
                updateIndex('val-kospi', data.KOSPI, data.KOSPI_TYPE);
                updateIndex('val-kosdaq', data.KOSDAQ, data.KOSDAQ_TYPE);

                if (data.updateTime) {
                    document.getElementById('val-time').innerText = data.updateTime;
                }

            } catch (err) {
                console.error("ðŸ“Š [ì§€ìˆ˜ ì—…ë°ì´íŠ¸ ì—ëŸ¬]:", err);
                const timeEl = document.getElementById('val-time');
                if (timeEl) timeEl.innerText = "ì—°ê²°ì§€ì—°";
            } finally {
                setTimeout(() => {
                    if (icon) icon.classList.remove('spinning');
                    if (btn) btn.style.opacity = '1';
                    __isFetching = false;
                }, 600);
            }
        };
    })();
</script>
</div>