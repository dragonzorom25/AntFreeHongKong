<div th:fragment="topFragment">
  <header class="top-bar">
    <div class="left-section">
      <button id="menuToggle" title="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">
        <i class="fas fa-bars"></i>
      </button>
      <h1 class="site-title">AntFreeHongKong</h1>
    </div>

    <div class="right-section">
      <div id="profileBtn" class="unified-btn" title="í”„ë¡œí•„">
        <i class="fas fa-user-circle"></i>
      </div>

      <div id="sessionRefreshContainer" class="unified-btn session-refresh-btn" title="Remaining time">
        <i class="fas fa-clock" id="timerIcon"></i>
        <span id="sessionTimer">--:--</span>
        <i id="refreshSessionBtn" class="fas fa-rotate-right" title="Refresh"></i>
      </div>

      <button id="logoutBtn" class="unified-btn" title="ë¡œê·¸ì•„ì›ƒ">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <div id="profileLayer" class="profile-layer">
    <h3>ë‚´ í”„ë¡œí•„</h3>
    <label>ì´ë¦„:<input type="text" id="profileName" readonly></label>
    <label>ì´ë©”ì¼:<input type="email" id="profileEmail" placeholder="you@example.com" readonly></label>

    <!-- ë‹¤í¬ ëª¨ë“œ í† ê¸€ -->
    <div class="darkmode-toggle">
      <span class="label">ë‹¤í¬ ëª¨ë“œ</span>
      <label class="switch">
        <input type="checkbox" id="darkModeSwitch" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- í•˜ë‹¨ ë°” í‘œì‹œ í† ê¸€ ì¶”ê°€ -->
    <div class="infobar-toggle" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
      <span class="label" style="font-size: 14px;">í•˜ë‹¨ ì •ë³´ ë°” í‘œì‹œ</span>
      <label class="switch">
        <input type="checkbox" id="infoBarSwitch" checked />
        <span class="slider"></span>
      </label>
    </div>

    <div class="profile-layer-btns">
      <button id="closeProfileBtn">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="sessionAlert" class="session-alert" style="display: none;"></div>

<style>
  /* ë‹¤í¬ëª¨ë“œ ì‹œ í•˜ë‹¨ ë°”(info-bar-fixed) ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© */
  body.dark-mode .info-bar-fixed,
  body.dark-mode .bottom-info-bar {
    background-color: #1e293b !important; /* ë‹¤í¬ëª¨ë“œìš© ë°°ê²½ìƒ‰ */
    border-top: 1px solid #334155 !important;
    color: #f1f5f9 !important;
  }
  body.dark-mode .info-bar-fixed .info-value,
  body.dark-mode .bottom-info-bar .value-text {
    color: #38bdf8 !important; /* ê°•ì¡° í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
  }
  
  /* í•˜ë‹¨ ë°” ìˆ¨ê¹€ ì²˜ë¦¬ë¥¼ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
  body.hide-infobar .info-bar-fixed,
  body.hide-infobar .bottom-info-bar {
    display: none !important;
  }
  /* í•˜ë‹¨ ë°”ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ ë³¸ë¬¸ íŒ¨ë”© ì¡°ì • */
  body.hide-infobar {
    padding-bottom: 0 !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (sel) => document.querySelector(sel);
  const menuToggleBtn = $("#menuToggle");
  const profileBtn = $("#profileBtn");
  const profileLayer = $("#profileLayer");
  const closeProfileBtn = $("#closeProfileBtn");
  const timerEl = $("#sessionTimer");
  const timerIcon = $("#timerIcon");
  const refreshBtn = $("#refreshSessionBtn");
  const logoutBtn = $("#logoutBtn");
  const profileNameInput = $("#profileName");
  const profileEmailInput = $("#profileEmail");
  const alertBox = $("#sessionAlert");
  const darkSwitch = $("#darkModeSwitch");
  
  // í•˜ë‹¨ ë°” ìŠ¤ìœ„ì¹˜ ì¶”ê°€
  const infoBarSwitch = $("#infoBarSwitch");
  
  let timerInterval = null;

  // ğŸš© ì¤‘ë³µ í´ë¦­ ë°©ì§€ìš© í”Œë˜ê·¸
  let isRefreshing = false;

  function setAlert(msg, autoHideMs = 1500) {
    if(!alertBox) return;
    alertBox.textContent = msg;
    alertBox.style.display = "block";
    setTimeout(() => (alertBox.style.display = "none"), autoHideMs);
  }

  // --- í…Œë§ˆ ë¡œë“œ ---
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    if(darkSwitch) darkSwitch.checked = true;
  }

  darkSwitch?.addEventListener("change", () => {
    if (darkSwitch.checked) {
      document.body.classList.add("dark-mode");
      localStorage.setItem("theme", "dark");
    } else {
      document.body.classList.remove("dark-mode");
      localStorage.setItem("theme", "light");
    }
  });

  // --- í•˜ë‹¨ ì •ë³´ ë°” í‘œì‹œ í† ê¸€ ë¡œì§ ---
  function toggleInfoBar(show) {
    // í”„ë˜ê·¸ë¨¼íŠ¸ë³„ë¡œ ë‹¤ë¥¸ í´ë˜ìŠ¤ëª…ì„ ëª¨ë‘ ëŒ€ì‘ (info-bar-fixed ë˜ëŠ” bottom-info-bar)
    const infoBars = document.querySelectorAll(".info-bar-fixed, .bottom-info-bar");
    
    if (show) {
      document.body.classList.remove("hide-infobar");
      infoBars.forEach(bar => {
        bar.style.setProperty('display', 'flex', 'important');
      });
    } else {
      document.body.classList.add("hide-infobar");
      infoBars.forEach(bar => {
        bar.style.setProperty('display', 'none', 'important');
      });
    }
  }

  // ì´ˆê¸° ìƒíƒœ ë¡œë“œ (ì§€ì—° ì‹¤í–‰ì„ í†µí•´ DOM ë Œë”ë§ í›„ ì ìš© ë³´ì¥)
  const savedInfoBar = localStorage.getItem("showInfoBar");
  if (savedInfoBar === "false") {
    if (infoBarSwitch) infoBarSwitch.checked = false;
    // í•˜ë‹¨ë°” í”„ë˜ê·¸ë¨¼íŠ¸ê°€ ë¡œë“œë˜ëŠ” ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì§€ì—° ì²˜ë¦¬
    setTimeout(() => toggleInfoBar(false), 200);
  } else {
    if (infoBarSwitch) infoBarSwitch.checked = true;
    setTimeout(() => toggleInfoBar(true), 200);
  }

  infoBarSwitch?.addEventListener("change", () => {
    const isChecked = infoBarSwitch.checked;
    toggleInfoBar(isChecked);
    localStorage.setItem("showInfoBar", isChecked);
  });

  // âœ… íƒ€ì´ë¨¸ ë¡œì§ (Math.ceil ë³´ì • ë²„ì „ ìœ ì§€)
  function startTimer(remainingMillis) {
    if (timerInterval) clearInterval(timerInterval);
    const endTime = Date.now() + remainingMillis;

    tick(); 
    timerInterval = setInterval(tick, 1000);

    function tick() {
      const remain = endTime - Date.now();
      if (remain <= 0) {
        clearInterval(timerInterval);
        if(timerEl) timerEl.textContent = "00:00";
        if(timerIcon) timerIcon.style.color = "var(--top-alert-danger-text)";
        setAlert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href = "/login"), 1500);
        return;
      }

      const totalSeconds = Math.ceil(remain / 1000); 
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;

      if(timerEl) timerEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      if(timerIcon) timerIcon.style.color = remain <= 5*60*1000 ? "var(--top-alert-warning-text)" : "";
    }
  }

  async function initProfileAndTimer() {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/validate", {
        headers: token ? {"Authorization":"Bearer "+token} : {},
        credentials: "include"
      });
      const data = await res.json();
      if (!res.ok || !data.valid) {
        setAlert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href="/login"), 1200);
        return;
      }
      startTimer(data.remainingMillis ?? 0);
      if(profileNameInput) profileNameInput.value = data.name || data.username || "";
      if(profileEmailInput) profileEmailInput.value = data.email || "";
    } catch { setAlert("ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨", 1500); }
  }

  // âœ… ì„¸ì…˜ ì—°ì¥ ë³¸ì²´ (ì¤‘ë³µ í´ë¦­ ë°©ì§€ ê°•í™”)
  async function refreshSession() {
    // ğŸš© 1ë‹¨ê³„: í”Œë˜ê·¸ ì²´í¬
    if (isRefreshing) return;
    isRefreshing = true;

    // ğŸš© 2ë‹¨ê³„: UI ì¦‰ì‹œ ë¹„í™œì„±í™” (ë²„íŠ¼ í´ë¦­ ë°©ì§€ ìŠ¤íƒ€ì¼)
    if (refreshBtn) refreshBtn.style.pointerEvents = "none";
    console.log("ì„¸ì…˜ ì—°ì¥ ì‹œì‘..."); 

    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/refresh", {
        method: "POST",
        headers: token ? { "Authorization": "Bearer " + token } : {},
        credentials: "include"
      });
      
      const body = await res.json().catch(() => ({}));
      
      if (!res.ok) { 
        setAlert(body.error || "ì„¸ì…˜ ì—°ì¥ ì‹¤íŒ¨", 1500); 
        return; 
      }
      
      if (body.token) localStorage.setItem("token", body.token);
      setAlert("ì„¸ì…˜ì´ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 1000);
      startTimer(body.sessionMillis ?? 15 * 60 * 1000);

    } catch (err) { 
      setAlert("ì„¸ì…˜ ì—°ì¥ ì¤‘ ì˜¤ë¥˜", 1500); 
    } finally {
      // ğŸš© 3ë‹¨ê³„: 1ì´ˆ í›„ ì§€ì—° í•´ì œ (ë„¤íŠ¸ì›Œí¬ ì§€ì—° ë° ë¬¼ë¦¬ì  ì—°íƒ€ ë°©ì§€)
      setTimeout(() => {
        isRefreshing = false;
        if (refreshBtn) refreshBtn.style.pointerEvents = "auto";
      }, 1000);
    }
  }

  async function doLogout() {
    try {
      const token = localStorage.getItem("token");
      await fetch("/auth/logout", {method:"POST",headers: token?{"Authorization":"Bearer "+token}:{},credentials:"include"});
    } finally {
      localStorage.removeItem("token");
      setAlert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.", 800);
      setTimeout(() => (location.href = "/login"), 800);
    }
  }

  menuToggleBtn?.addEventListener("click", () => {
    if (typeof window.toggleSidebar === "function") window.toggleSidebar();
    else document.querySelector(".sidebar")?.classList.toggle("open");
  });

  profileBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (profileLayer) profileLayer.style.display = profileLayer.style.display === "block" ? "none" : "block";
  });

  closeProfileBtn?.addEventListener("click", () => {
    if (profileLayer) profileLayer.style.display = "none";
  });

  document.addEventListener("click", (e) => {
    if (profileLayer?.style.display === "block" && !profileLayer.contains(e.target) && e.target !== profileBtn) {
      profileLayer.style.display = "none";
    }
  });

  // âœ… í´ë¦­ ë¦¬ìŠ¤ë„ˆ ê°•í™” (ì´ë²¤íŠ¸ ì „íŒŒ ì™„ì „ ì°¨ë‹¨)
  refreshBtn?.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    refreshSession();
  });

  logoutBtn?.addEventListener("click", doLogout);

  initProfileAndTimer();
});
</script>
</div>